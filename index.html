<!doctype html>
<html lang="es">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TD9HW3X5BD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TD9HW3X5BD');
    </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="¿Qué partido encaja mejor contigo en Aragón 2026? Responde afirmaciones y compara tu perfil con los programas oficiales."
    />
    <title>Cuestionario Electoral - Aragón 2026</title>

    <style>
      :root {
        --bg: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e2e8f0;
        --accent: #0f172a;
        --accent-2: #1f2937;
        --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 56px 20px 80px;
      }

      .card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 28px;
        box-shadow: var(--shadow);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 12px 18px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }

      .btn-outline {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 2px solid var(--border);
        background: #fff;
        color: var(--text);
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
      }

      .btn-outline:hover { border-color: var(--accent); }

      .scale-btn {
        width: 100%;
        text-align: left;
        padding: 12px 14px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: #fff;
        cursor: pointer;
        transition: border 0.2s ease, background 0.2s ease;
      }

      .scale-btn:hover { border-color: var(--accent); }
      .scale-btn.selected { border-color: var(--accent); background: #f8fafc; }

      .progress {
        height: 8px;
        background: #e2e8f0;
        border-radius: 999px;
        overflow: hidden;
      }

      .progress > div {
        height: 100%;
        background: #0f172a;
      }

      .party-row {
        display: flex;
        gap: 24px;
        align-items: flex-start;
      }

      .party-logo {
        width: 96px;
        height: 96px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 700;
        font-size: 28px;
      }

      .party-bar {
        height: 12px;
        border: 1px solid #cbd5e1;
        background: #e2e8f0;
      }

      @media (max-width: 640px) {
        .party-row { flex-direction: column; align-items: flex-start; }
      }
    </style>
  </head>

  <body>
    <main class="container">

      <!-- LANDING -->
      <section id="landing">
        <h1 style="font-size:40px; margin:0 0 12px;">¿Qué partido encaja mejor contigo en Aragón 2026?</h1>
        <p style="color:var(--muted); margin:0 0 24px;">
          Responde afirmaciones (de “totalmente en desacuerdo” a “totalmente de acuerdo”) y compara tu perfil con los programas oficiales.
        </p>

        <div class="card" style="margin-bottom:20px;">
          <h2 style="margin:0 0 12px; font-size:18px;">Elige tu prioridad principal (pesará x2)</h2>
          <div id="priorityButtons" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
          <p style="font-size:12px; color:var(--muted); margin-top:10px;">Puedes dejarlo sin seleccionar.</p>
        </div>

        <button id="startBtn" class="btn">Empezar</button>
      </section>

      <!-- DEMOGRAPHICS (NEW) -->
      <section id="demographics" style="display:none;">
        <h1 style="font-size:32px; margin:0 0 12px;">Información demográfica (opcional)</h1>
        <p style="color:var(--muted); margin:0 0 18px;">
          Esto no afecta al ranking (por defecto). Sirve para análisis agregado o futuras mejoras.
        </p>

        <div class="card">
          <form id="demoForm" style="display:grid; gap:14px;">
            <div>
              <label style="display:block; font-size:13px; color:var(--muted); margin:0 0 6px;">Género</label>
              <select id="demo_genero" class="scale-btn" style="text-align:left;">
                <option>Prefiero no decir</option>
                <option>Hombre</option>
                <option>Mujer</option>
                <option>Otro</option>
              </select>
            </div>

            <div>
              <label style="display:block; font-size:13px; color:var(--muted); margin:0 0 6px;">Provincia</label>
              <select id="demo_provincia" class="scale-btn" style="text-align:left;">
                <option>Prefiero no decir</option>
                <option>Zaragoza</option>
                <option>Huesca</option>
                <option>Teruel</option>
              </select>
            </div>

            <div>
              <label style="display:block; font-size:13px; color:var(--muted); margin:0 0 6px;">Salario (bruto anual)</label>
              <select id="demo_salario" class="scale-btn" style="text-align:left;">
                <option>Prefiero no decir</option>
                <option>Menos de 20.000€</option>
                <option>20.000€ – 35.000€</option>
                <option>35.000€ – 50.000€</option>
                <option>50.000€ – 80.000€</option>
                <option>Más de 80.000€</option>
              </select>
            </div>

            <div>
              <label style="display:block; font-size:13px; color:var(--muted); margin:0 0 6px;">Situación laboral</label>
              <select id="demo_situacion_laboral" class="scale-btn" style="text-align:left;">
                <option>Prefiero no decir</option>
                <option>Estudiante / en formación</option>
                <option>Empleado/a con contrato estable</option>
                <option>Empleado/a temporal</option>
                <option>Autónomo/a o emprendedor/a</option>
                <option>Jubilado/a o en transición a la jubilación</option>
              </select>
            </div>

            <div>
              <label style="display:block; font-size:13px; color:var(--muted); margin:0 0 6px;">Situación de vivienda</label>
              <select id="demo_vivienda_status" class="scale-btn" style="text-align:left;">
                <option>Prefiero no decir</option>
                <option>Alquiler</option>
                <option>Propietario</option>
                <option>Multipropiedad</option>
                <option>Otra</option>
              </select>
            </div>

            <div style="display:flex; gap:10px; margin-top:6px;">
              <button id="demoSkipBtn" type="button" class="btn-outline">Saltar</button>
              <button id="demoContinueBtn" type="submit" class="btn" style="margin-left:auto;">Continuar</button>
            </div>
          </form>
        </div>
      </section>

      <!-- QUIZ -->
      <section id="quiz" style="display:none;">
        <div style="margin-bottom:16px;">
          <div class="progress"><div id="progressFill" style="width:0%"></div></div>
          <div id="progressText" style="margin-top:6px; color:var(--muted); font-size:13px;"></div>
        </div>

        <div class="card">
          <h2 id="statementText" style="margin:0 0 18px; font-size:24px;"></h2>
          <div id="scaleOptions" style="display:grid; gap:8px;"></div>

          <div style="display:flex; gap:10px; margin-top:18px;">
            <button id="prevBtn" class="btn-outline">Atrás</button>
            <button id="nextBtn" class="btn" style="margin-left:auto;">Siguiente</button>
          </div>
        </div>

        <div style="font-size:12px; color:var(--muted); margin-top:12px;">
          Esta herramienta compara tus respuestas con los programas oficiales. No sustituye el criterio personal ni recomienda el voto.
        </div>
      </section>

      <!-- RESULTS -->
      <section id="results" style="display:none;">
        <h1 style="font-size:36px; margin:0 0 16px;">¿En qué medida coincides con las propuestas de los partidos?</h1>

        <div id="resultsList" style="display:grid; gap:28px; margin-bottom:24px;"></div>

        <div class="card" style="margin-bottom:24px;">
          <h2 style="margin:0 0 12px; font-size:18px;">Ver programas (Top 3)</h2>
          <div id="top3Links" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
        </div>

        <div class="card" style="margin-bottom:24px;">
          <h2 style="margin:0 0 12px; font-size:18px;">Compartir resultados</h2>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="shareBtn" class="btn">Compartir</button>
            <button id="downloadBtn" class="btn-outline">Descargar imagen</button>
          </div>
          <div id="sharePreviewWrap" style="display:none; margin-top:12px;">
            <p style="font-size:12px; color:var(--muted); margin:0 0 6px;">Vista previa (PNG 1200×630)</p>
            <img id="sharePreview" alt="Vista previa resultados" style="width:100%; border-radius:12px; border:1px solid var(--border);" />
          </div>
        </div>

        <div class="card" style="background:#f8fafc; text-align:center; font-size:13px; color:var(--muted);">
          Esta herramienta compara tus respuestas con los programas oficiales. No sustituye el criterio personal ni recomienda el voto.
        </div>
      </section>
    </main>

    <!-- DATA EMBED (unchanged; your DATA stays here) -->
    <script>
      const DATA = {"schema_version":"votecompass_aragon_2026_v1","scale":{"min":-2,"max":2,"labels":{"-2":"Totalmente en desacuerdo","-1":"En desacuerdo","0":"Neutral / No lo sé","1":"De acuerdo","2":"Totalmente de acuerdo"}},"statements":[{"id":"vivienda_alquiler_topes","text":"El Gobierno de Aragón debería limitar el precio del alquiler en zonas tensionadas.","topic":"vivienda","polarity":"pro-regulacion"},{"id":"vivienda_publica_parque","text":"Aragón debería aumentar de forma significativa el parque de vivienda pública en alquiler asequible.","topic":"vivienda","polarity":"pro-publico"},{"id":"vivienda_ayudas_compra","text":"Deberían priorizarse ayudas fiscales y subvenciones para comprar primera vivienda (frente a regular alquileres).","topic":"vivienda","polarity":"pro-compra"},{"id":"transportes_transporte_publico_tarifas","text":"Deberían abaratarse y ampliarse las tarifas/servicios de transporte público (urbano e interurbano).","topic":"transportes","polarity":"pro-publico"},{"id":"transportes_carreteras","text":"La prioridad en transportes debe ser invertir más en carreteras y autovías.","topic":"transportes","polarity":"pro-carretera"},{"id":"transportes_ferrocarril","text":"Aragón debería priorizar inversión en ferrocarril (cercanías, media distancia y conexiones).","topic":"transportes","polarity":"pro-ferrocarril"},{"id":"sanidad_financiacion_publica","text":"Aragón debería aumentar el gasto público sanitario aunque implique subir impuestos o déficit.","topic":"sanidad","polarity":"pro-publico"},{"id":"sanidad_privada_incentivos","text":"Deberían incentivarse fórmulas privadas o concertadas para reducir listas de espera.","topic":"sanidad","polarity":"pro-privado"},{"id":"sanidad_primaria_rural","text":"La atención primaria y la sanidad rural deben reforzarse con más profesionales y recursos.","topic":"sanidad","polarity":"pro-primaria"},{"id":"economia_bajada_impuestos","text":"Aragón debería bajar impuestos para familias y empresas como medida prioritaria.","topic":"economia","polarity":"pro-bajada"},{"id":"economia_pymes_industria","text":"Las ayudas y la política industrial deberían centrarse en pymes, reindustrialización y empleo local.","topic":"economia","polarity":"pro-pymes"},{"id":"economia_transicion_ecologica","text":"Aragón debe acelerar la transición energética y la descarbonización aunque encarezca costes a corto plazo.","topic":"economia","polarity":"pro-clima"},{"id":"educacion_publica_refuerzo","text":"Se debería reforzar la educación pública (infantil, primaria y secundaria) con más recursos y personal.","topic":"educacion","polarity":"pro-publica"},{"id":"educacion_libertad_concertada","text":"Debe ampliarse la libertad de elección (bonos/cheque escolar) y el peso de la concertada/privada.","topic":"educacion","polarity":"pro-concertada"},{"id":"sociales_dependencia","text":"Aragón debería aumentar la inversión en dependencia y cuidados de larga duración.","topic":"sociales","polarity":"pro-cuidados"},{"id":"sociales_igualdad_lgtbi","text":"Las políticas de igualdad y LGTBI deben reforzarse y transversalizarse en la acción de gobierno.","topic":"sociales","polarity":"pro-igualdad"},{"id":"otro_inmigracion_control","text":"La inmigración debería controlarse más estrictamente y condicionarse a la integración y al empleo.","topic":"otro","polarity":"pro-control"},{"id":"otro_seguridad_endurecer","text":"Deberían endurecerse las políticas de seguridad (más policía y sanciones).","topic":"otro","polarity":"pro-endurecer"},{"id":"otro_medioambiente_proteccion","text":"Aragón debería priorizar la protección ambiental (agua, biodiversidad) incluso si limita ciertos proyectos.","topic":"otro","polarity":"pro-ambiental"},{"id":"otro_aragon_autogobierno","text":"Debe reforzarse el autogobierno y la identidad aragonesa (competencias, lengua/cultura).","topic":"otro","polarity":"pro-autogobierno"}],"parties":[{"party":"CHA","meta":{"short":"CHA","color":"#f97316"},"positions":{"vivienda_alquiler_topes":0,"vivienda_publica_parque":0,"vivienda_ayudas_compra":0,"transportes_transporte_publico_tarifas":0,"transportes_carreteras":0,"transportes_ferrocarril":0,"sanidad_financiacion_publica":0,"sanidad_privada_incentivos":0,"sanidad_primaria_rural":0,"economia_bajada_impuestos":0,"economia_pymes_industria":2,"economia_transicion_ecologica":0,"educacion_publica_refuerzo":2,"educacion_libertad_concertada":0,"sociales_dependencia":2,"sociales_igualdad_lgtbi":2,"otro_inmigracion_control":0,"otro_seguridad_endurecer":1,"otro_medioambiente_proteccion":0,"otro_aragon_autogobierno":0},"source_pdf":"https://www.chunta.org/aragon26/"},{"party":"PSOE Aragón","meta":{"short":"PSOE","color":"#ef4444"},"positions":{"vivienda_alquiler_topes":0,"vivienda_publica_parque":0,"vivienda_ayudas_compra":0,"transportes_transporte_publico_tarifas":2,"transportes_carreteras":0,"transportes_ferrocarril":0,"sanidad_financiacion_publica":0,"sanidad_privada_incentivos":-2,"sanidad_primaria_rural":0,"economia_bajada_impuestos":1,"economia_pymes_industria":2,"economia_transicion_ecologica":0,"educacion_publica_refuerzo":2,"educacion_libertad_concertada":-1,"sociales_dependencia":2,"sociales_igualdad_lgtbi":2,"otro_inmigracion_control":0,"otro_seguridad_endurecer":0,"otro_medioambiente_proteccion":2,"otro_aragon_autogobierno":0},"source_pdf":"https://aragonpsoe.es/wp-content/uploads/2026/01/Programa-Electoral-PSOE-Aragon-2026-2030.pdf"},{"party":"PP Aragón","meta":{"short":"PP","color":"#1d4ed8"},"positions":{"vivienda_alquiler_topes":0,"vivienda_publica_parque":0,"vivienda_ayudas_compra":0,"transportes_transporte_publico_tarifas":2,"transportes_carreteras":0,"transportes_ferrocarril":0,"sanidad_financiacion_publica":0,"sanidad_privada_incentivos":0,"sanidad_primaria_rural":0,"economia_bajada_impuestos":0,"economia_pymes_industria":2,"economia_transicion_ecologica":0,"educacion_publica_refuerzo":0,"educacion_libertad_concertada":0,"sociales_dependencia":2,"sociales_igualdad_lgtbi":2,"otro_inmigracion_control":0,"otro_seguridad_endurecer":0,"otro_medioambiente_proteccion":2,"otro_aragon_autogobierno":0},"source_pdf":"http://www.pparagon.es/"},{"party":"VOX Aragón","meta":{"short":"VOX","color":"#16a34a"},"positions":{"vivienda_alquiler_topes":-2,"vivienda_publica_parque":-1,"vivienda_ayudas_compra":2,"transportes_transporte_publico_tarifas":-1,"transportes_carreteras":2,"transportes_ferrocarril":0,"sanidad_financiacion_publica":-1,"sanidad_privada_incentivos":2,"sanidad_primaria_rural":0,"economia_bajada_impuestos":2,"economia_pymes_industria":1,"economia_transicion_ecologica":-2,"educacion_publica_refuerzo":-1,"educacion_libertad_concertada":2,"sociales_dependencia":0,"sociales_igualdad_lgtbi":-2,"otro_inmigracion_control":2,"otro_seguridad_endurecer":2,"otro_medioambiente_proteccion":-1,"otro_aragon_autogobierno":-1},"source_pdf":"https://www.voxespana.es/wp-content/uploads/2026/01/PROGRAMA-ELECTORAL-VOX-ARAGON-2026.pdf"},{"party":"PAR","meta":{"short":"PAR","color":"#0ea5e9"},"positions":{"vivienda_alquiler_topes":2,"vivienda_publica_parque":0,"vivienda_ayudas_compra":0,"transportes_transporte_publico_tarifas":2,"transportes_carreteras":0,"transportes_ferrocarril":0,"sanidad_financiacion_publica":2,"sanidad_privada_incentivos":1,"sanidad_primaria_rural":0,"economia_bajada_impuestos":0,"economia_pymes_industria":2,"economia_transicion_ecologica":0,"educacion_publica_refuerzo":1,"educacion_libertad_concertada":1,"sociales_dependencia":1,"sociales_igualdad_lgtbi":2,"otro_inmigracion_control":0,"otro_seguridad_endurecer":2,"otro_medioambiente_proteccion":0,"otro_aragon_autogobierno":0},"source_pdf":"https://partidoaragones.es/wp-content/uploads/2026/01/programa2026PAR.pdf"},{"party":"SALF","meta":{"short":"SALF","color":"#14b8a6"},"positions":{"vivienda_alquiler_topes":0,"vivienda_publica_parque":0,"vivienda_ayudas_compra":2,"transportes_transporte_publico_tarifas":2,"transportes_carreteras":0,"transportes_ferrocarril":1,"sanidad_financiacion_publica":0,"sanidad_privada_incentivos":0,"sanidad_primaria_rural":0,"economia_bajada_impuestos":0,"economia_pymes_industria":2,"economia_transicion_ecologica":0,"educacion_publica_refuerzo":2,"educacion_libertad_concertada":0,"sociales_dependencia":2,"sociales_igualdad_lgtbi":2,"otro_inmigracion_control":2,"otro_seguridad_endurecer":0,"otro_medioambiente_proteccion":0,"otro_aragon_autogobierno":0},"source_pdf":"https://www.seacabolafiesta.com/aragon"},{"party":"IU / Sumar","meta":{"short":"IU","color":"#f59e0b"},"positions":{"vivienda_alquiler_topes":0,"vivienda_publica_parque":0,"vivienda_ayudas_compra":0,"transportes_transporte_publico_tarifas":2,"transportes_carreteras":-1,"transportes_ferrocarril":0,"sanidad_financiacion_publica":0,"sanidad_privada_incentivos":0,"sanidad_primaria_rural":0,"economia_bajada_impuestos":0,"economia_pymes_industria":2,"economia_transicion_ecologica":0,"educacion_publica_refuerzo":2,"educacion_libertad_concertada":1,"sociales_dependencia":2,"sociales_igualdad_lgtbi":2,"otro_inmigracion_control":0,"otro_seguridad_endurecer":0,"otro_medioambiente_proteccion":0,"otro_aragon_autogobierno":0},"source_pdf":"https://www.iuaragon.com/wp-content/uploads/2026/01/iu_sumar_programa_revista.pdf"},{"party":"Podemos - Alianza Verde","meta":{"short":"POD","color":"#7c3aed"},"positions":{"vivienda_alquiler_topes":0,"vivienda_publica_parque":0,"vivienda_ayudas_compra":0,"transportes_transporte_publico_tarifas":2,"transportes_carreteras":0,"transportes_ferrocarril":0,"sanidad_financiacion_publica":0,"sanidad_privada_incentivos":0,"sanidad_primaria_rural":0,"economia_bajada_impuestos":0,"economia_pymes_industria":2,"economia_transicion_ecologica":0,"educacion_publica_refuerzo":2,"educacion_libertad_concertada":0,"sociales_dependencia":2,"sociales_igualdad_lgtbi":2,"otro_inmigracion_control":0,"otro_seguridad_endurecer":0,"otro_medioambiente_proteccion":2,"otro_aragon_autogobierno":0},"source_pdf":"https://www.heraldo.es/uploads/files/2026/01/30/Programa%20completo%20Podemos-Alianza%20Verde.pdf"},{"party":"Aragón Existe","meta":{"short":"AE","color":"#22c55e"},"positions":{"vivienda_alquiler_topes":0,"vivienda_publica_parque":0,"vivienda_ayudas_compra":0,"transportes_transporte_publico_tarifas":2,"transportes_carreteras":0,"transportes_ferrocarril":0,"sanidad_financiacion_publica":2,"sanidad_privada_incentivos":2,"sanidad_primaria_rural":0,"economia_bajada_impuestos":1,"economia_pymes_industria":2,"economia_transicion_ecologica":0,"educacion_publica_refuerzo":2,"educacion_libertad_concertada":-2,"sociales_dependencia":2,"sociales_igualdad_lgtbi":0,"otro_inmigracion_control":0,"otro_seguridad_endurecer":0,"otro_medioambiente_proteccion":2,"otro_aragon_autogobierno":0},"source_pdf":"https://aragonexiste.org/wp-content/uploads/2026/01/Programa-autonomico-8F-Aragon-Existe.pdf"}]};
    </script>

    <!-- APP LOGIC -->
    <script>
      const SCALE = [
        { label: "Totalmente en desacuerdo", value: -2 },
        { label: "En desacuerdo", value: -1 },
        { label: "Neutral / No lo sé", value: 0 },
        { label: "De acuerdo", value: 1 },
        { label: "Totalmente de acuerdo", value: 2 }
      ];

      // Fallbacks (now official links too)
      const partyPdfFallback = {
        "PP Aragón": "http://www.pparagon.es/",
        "PSOE Aragón": "https://aragonpsoe.es/wp-content/uploads/2026/01/Programa-Electoral-PSOE-Aragon-2026-2030.pdf",
        "VOX Aragón": "https://www.voxespana.es/wp-content/uploads/2026/01/PROGRAMA-ELECTORAL-VOX-ARAGON-2026.pdf",
        "Podemos - Alianza Verde": "https://www.heraldo.es/uploads/files/2026/01/30/Programa%20completo%20Podemos-Alianza%20Verde.pdf",
        "IU / Sumar": "https://www.iuaragon.com/wp-content/uploads/2026/01/iu_sumar_programa_revista.pdf",
        "CHA": "https://www.chunta.org/aragon26/",
        "PAR": "https://partidoaragones.es/wp-content/uploads/2026/01/programa2026PAR.pdf",
        "Aragón Existe": "https://aragonexiste.org/wp-content/uploads/2026/01/Programa-autonomico-8F-Aragon-Existe.pdf",
        "SALF": "https://www.seacabolafiesta.com/aragon"
      };

      const partyStyleFallback = {
        "PP Aragón": { short: "PP", color: "#1d4ed8" },
        "PSOE Aragón": { short: "PSOE", color: "#ef4444" },
        "VOX Aragón": { short: "VOX", color: "#16a34a" },
        "Podemos - Alianza Verde": { short: "POD", color: "#7c3aed" },
        "IU / Sumar": { short: "IU", color: "#f59e0b" },
        "CHA": { short: "CHA", color: "#f97316" },
        "PAR": { short: "PAR", color: "#0ea5e9" },
        "Aragón Existe": { short: "AE", color: "#22c55e" },
        "SALF": { short: "SALF", color: "#14b8a6" }
      };

      function scoreParties({ statements, parties, userAnswers, userPriorityTopic }) {
        const answered = (statements || []).filter(
          (s) => userAnswers[s.id] !== undefined && userAnswers[s.id] !== null
        );

        const maxDistance = answered.reduce((acc, s) => {
          const w = userPriorityTopic && s.topic === userPriorityTopic ? 2 : 1;
          return acc + 4 * w;
        }, 0);

        return (parties || [])
          .map((p) => {
            let distance = 0;

            const comparisons = answered.map((s) => {
              const user = userAnswers[s.id];
              const partyPos = p.positions?.[s.id];
              const partyValue = Number.isFinite(partyPos) ? partyPos : 0;

              const weight = userPriorityTopic && s.topic === userPriorityTopic ? 2 : 1;
              const delta = Math.abs(user - partyValue);

              distance += delta * weight;

              return {
                statementId: s.id,
                topic: s.topic,
                text: s.text,
                user,
                party: partyValue,
                delta,
                weight
              };
            });

            const percentage = maxDistance
              ? Math.round(100 - (distance / maxDistance) * 100)
              : 0;

            comparisons.sort((a, b) => a.delta - b.delta);

            return {
              party: p.party,
              percentage: Math.max(0, Math.min(100, percentage)),
              distance,
              maxDistance,
              topReasons: comparisons.slice(0, 3)
            };
          })
          .sort((a, b) => b.percentage - a.percentage);
      }

      const state = {
        stage: "landing",
        i: 0,
        answers: {},
        priority: null,
        results: [],
        data: DATA,
        shareImgUrl: null,
        demographics: null // NEW
      };

      const el = {
        landing: document.getElementById("landing"),
        demographics: document.getElementById("demographics"), // NEW
        quiz: document.getElementById("quiz"),
        results: document.getElementById("results"),
        startBtn: document.getElementById("startBtn"),
        priorityButtons: document.getElementById("priorityButtons"),
        progressFill: document.getElementById("progressFill"),
        progressText: document.getElementById("progressText"),
        statementText: document.getElementById("statementText"),
        scaleOptions: document.getElementById("scaleOptions"),
        prevBtn: document.getElementById("prevBtn"),
        nextBtn: document.getElementById("nextBtn"),
        resultsList: document.getElementById("resultsList"),
        top3Links: document.getElementById("top3Links"),
        shareBtn: document.getElementById("shareBtn"),
        downloadBtn: document.getElementById("downloadBtn"),
        sharePreviewWrap: document.getElementById("sharePreviewWrap"),
        sharePreview: document.getElementById("sharePreview"),

        // NEW: demographics inputs
        demoForm: document.getElementById("demoForm"),
        demo_genero: document.getElementById("demo_genero"),
        demo_provincia: document.getElementById("demo_provincia"),
        demo_salario: document.getElementById("demo_salario"),
        demo_situacion_laboral: document.getElementById("demo_situacion_laboral"),
        demo_vivienda_status: document.getElementById("demo_vivienda_status"),
        demoSkipBtn: document.getElementById("demoSkipBtn")
      };

      const topics = ["vivienda","transportes","sanidad","economia","educacion","sociales","otro"];

      function partyStyle(p) {
        return {
          short: p?.meta?.short || partyStyleFallback[p.party]?.short || p.party.slice(0, 3).toUpperCase(),
          color: p?.meta?.color || partyStyleFallback[p.party]?.color || "#0f172a"
        };
      }

      function show(stage) {
        state.stage = stage;
        el.landing.style.display = stage === "landing" ? "block" : "none";
        el.demographics.style.display = stage === "demographics" ? "block" : "none"; // NEW
        el.quiz.style.display = stage === "quiz" ? "block" : "none";
        el.results.style.display = stage === "results" ? "block" : "none";
      }

      function renderPriorityButtons() {
        el.priorityButtons.innerHTML = "";
        topics.forEach((t) => {
          const b = document.createElement("button");
          b.className = "btn-outline";
          b.textContent = t;
          if (state.priority === t) {
            b.style.borderColor = "#0f172a";
          }
          b.addEventListener("click", () => {
            state.priority = state.priority === t ? null : t;
            renderPriorityButtons();
          });
          el.priorityButtons.appendChild(b);
        });
      }

      function renderQuestion() {
        const statements = state.data?.statements || [];
        const current = statements[state.i];
        if (!current) return;

        const progress = Math.round(((state.i + 1) / statements.length) * 100);
        el.progressFill.style.width = progress + "%";
        el.progressText.textContent =
          "Afirmación " + (state.i + 1) + " de " + statements.length +
          " · tema: " + current.topic + (state.priority === current.topic ? " (x2)" : "");

        el.statementText.textContent = current.text;

        el.scaleOptions.innerHTML = "";
        SCALE.forEach((o) => {
          const btn = document.createElement("button");
          btn.className = "scale-btn";
          if (state.answers[current.id] === o.value) btn.classList.add("selected");
          btn.textContent = o.label;
          btn.addEventListener("click", () => {
            state.answers[current.id] = o.value;
            renderQuestion();
          });
          el.scaleOptions.appendChild(btn);
        });

        el.prevBtn.disabled = state.i === 0;
        el.nextBtn.textContent = (state.i < statements.length - 1) ? "Siguiente" : "Ver resultados";

        const selected = state.answers[current.id];
        el.nextBtn.disabled = selected === undefined;
      }

      function finish() {
        const statements = state.data?.statements || [];
        const parties = state.data?.parties || [];
        state.results = scoreParties({
          statements,
          parties,
          userAnswers: state.answers,
          userPriorityTopic: state.priority
        });
        renderResults();
        show("results");
      }

      function getPartyPdfUrl(partyName) {
        const p = (state.data?.parties || []).find((x) => x.party === partyName);
        return p?.source_pdf || partyPdfFallback[partyName] || null;
      }

      function renderResults() {
        el.resultsList.innerHTML = "";
        el.top3Links.innerHTML = "";

        const parties = state.data?.parties || [];

        state.results.forEach((r) => {
          const p = parties.find((x) => x.party === r.party);
          const st = partyStyle(p);

          const row = document.createElement("div");
          row.className = "party-row";

          const logo = document.createElement("div");
          logo.className = "party-logo";
          logo.style.backgroundColor = st.color;
          logo.textContent = st.short;

          const mid = document.createElement("div");
          mid.style.flex = "1";

          const top = document.createElement("div");
          top.style.display = "flex";
          top.style.justifyContent = "space-between";
          top.style.gap = "12px";

          const left = document.createElement("div");
          const name = document.createElement("div");
          name.style.fontSize = "24px";
          name.style.fontWeight = "700";
          name.textContent = r.party;
          const short = document.createElement("div");
          short.style.fontSize = "24px";
          short.textContent = st.short;
          left.appendChild(name);
          left.appendChild(short);

          const pct = document.createElement("div");
          pct.style.fontSize = "24px";
          pct.style.fontWeight = "700";
          pct.textContent = r.percentage + "%";

          top.appendChild(left);
          top.appendChild(pct);

          const bar = document.createElement("div");
          bar.className = "party-bar";
          bar.style.marginTop = "12px";

          const fill = document.createElement("div");
          fill.style.height = "100%";
          fill.style.width = Math.max(0, Math.min(100, r.percentage)) + "%";
          fill.style.backgroundColor = st.color;
          bar.appendChild(fill);

          const reasons = document.createElement("div");
          reasons.style.marginTop = "10px";
          reasons.style.fontSize = "12px";
          reasons.style.color = "#475569";
          if (r.topReasons?.length) {
            reasons.textContent = "Coincides especialmente en: " + r.topReasons.map(x => x.topic).join(", ");
          }

          mid.appendChild(top);
          mid.appendChild(bar);
          mid.appendChild(reasons);

          const pdf = getPartyPdfUrl(r.party);
          if (pdf) {
            const link = document.createElement("a");
            link.href = pdf;
            link.target = "_blank";
            link.rel = "noreferrer";
            link.style.display = "inline-flex";
            link.style.alignItems = "center";
            link.style.gap = "6px";
            link.style.marginTop = "8px";
            link.style.fontSize = "12px";
            link.style.fontWeight = "600";
            link.style.color = "#0f172a";
            link.textContent = "Ver programa";
            mid.appendChild(link);
          }

          row.appendChild(logo);
          row.appendChild(mid);
          el.resultsList.appendChild(row);
        });

        state.results.slice(0, 3).forEach((r) => {
          const url = getPartyPdfUrl(r.party);
          const a = document.createElement("a");
          a.href = url || "#";
          a.target = "_blank";
          a.rel = "noreferrer";
          a.className = "btn-outline";
          if (!url) {
            a.style.pointerEvents = "none";
            a.style.opacity = "0.5";
          }
          a.textContent = r.party;
          el.top3Links.appendChild(a);
        });
      }

      // --------- DEMOGRAPHICS LOGIC (NEW) ---------
      const laborMap = {
        "Estudiante / en formación": "situacion_laboral.estudiante",
        "Empleado/a con contrato estable": "situacion_laboral.empleo_estable",
        "Empleado/a temporal": "situacion_laboral.empleo_temporal",
        "Autónomo/a o emprendedor/a": "situacion_laboral.autonomo",
        "Jubilado/a o en transición a la jubilación": "situacion_laboral.jubilacion"
      };

      function goToQuiz() {
        show("quiz");
        state.i = 0;
        renderQuestion();
      }

      el.demoSkipBtn.addEventListener("click", () => {
        state.demographics = null;
        goToQuiz();
      });

      el.demoForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const d = {
          genero: el.demo_genero.value,
          provincia: el.demo_provincia.value,
          salario: el.demo_salario.value,
          situacion_laboral: el.demo_situacion_laboral.value,
          vivienda_status: el.demo_vivienda_status.value
        };

        if (laborMap[d.situacion_laboral]) {
          d.situacion_laboral_tag = laborMap[d.situacion_laboral];
        }

        state.demographics = d;
        goToQuiz();
      });
      // --------------------------------------------

      // NOTE: share image helpers (buildShareImage) should exist in your file already.
      // If they are below in your original code, keep them as-is.

      el.startBtn.addEventListener("click", () => {
        show("demographics"); // CHANGED: landing -> demographics
      });

      el.prevBtn.addEventListener("click", () => {
        state.i = Math.max(0, state.i - 1);
        renderQuestion();
      });

      el.nextBtn.addEventListener("click", () => {
        const statements = state.data?.statements || [];
        if (state.i < statements.length - 1) {
          state.i += 1;
          renderQuestion();
        } else {
          finish();
        }
      });

      // If you already have shareResults/downloadShareImage handlers below, keep them.
      // el.shareBtn.addEventListener("click", shareResults);
      // el.downloadBtn.addEventListener("click", downloadShareImage);

      renderPriorityButtons();
      show("landing");
    </script>

    <!-- IMPORTANT:
      If your original file includes buildShareImage(), prepareShareAssets(), shareResults(), downloadShareImage()
      keep them exactly as they were (they were in your earlier version).
      Just make sure the two commented listeners above are connected to your existing functions.
    -->
  </body>
</html>

