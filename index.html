<!doctype html>
<html lang="es">
  <head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-TD9HW3X5BD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-TD9HW3X5BD');
    </script>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="¬øQu√© partido encaja mejor contigo en estas elecciones de Arag√≥n 2026? Responde 8 preguntas r√°pidas y descubre qu√© propuestas se alinean m√°s con tus prioridades."
    />
    <title>VoteCompass Arag√≥n 2026</title>

    <style>
      :root {
        --bg: #ffffff;
        --text: #0f172a;
        --muted: #64748b;
        --border: #e2e8f0;
        --accent: #0f172a;
        --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: var(--bg);
      }

      a { color: inherit; }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 56px 20px 80px;
      }

      .card {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 28px;
        box-shadow: var(--shadow);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--accent);
        color: #fff;
        border: none;
        padding: 12px 18px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
      }

      .btn:disabled {
        background: #94a3b8;
        cursor: not-allowed;
      }

      .btn-outline {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: 2px solid var(--border);
        background: #fff;
        color: var(--text);
        padding: 10px 14px;
        border-radius: 10px;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
      }

      .btn-outline:hover { border-color: var(--accent); }

      .scale-btn {
        width: 100%;
        text-align: left;
        padding: 12px 14px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: #fff;
        cursor: pointer;
        transition: border 0.2s ease, background 0.2s ease;
      }

      .scale-btn:hover { border-color: var(--accent); }
      .scale-btn.selected { border-color: var(--accent); background: #f8fafc; }

      .progress {
        height: 8px;
        background: #e2e8f0;
        border-radius: 999px;
        overflow: hidden;
      }

      .progress > div {
        height: 100%;
        background: #0f172a;
      }

      .party-row {
        display: flex;
        gap: 24px;
        align-items: flex-start;
      }

      .party-logo {
        width: 96px;
        height: 96px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 800;
        font-size: 28px;
      }

      .party-bar {
        height: 12px;
        border: 1px solid #cbd5e1;
        background: #e2e8f0;
        border-radius: 999px;
        overflow: hidden;
      }

      .pill {
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:8px 12px;
        border-radius:999px;
        border:1px solid var(--border);
        color: var(--muted);
        font-size: 12px;
        background:#fff;
      }

      .grid2 {
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }

      .field label {
        display:block;
        font-size: 12px;
        color: var(--muted);
        margin-bottom: 6px;
        font-weight: 700;
      }

      .field select, .field input {
        width: 100%;
        border: 2px solid var(--border);
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
        background: #fff;
      }

      .field select:focus, .field input:focus {
        border-color: var(--accent);
      }

      details {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px 16px;
        background: #fff;
      }

      details summary {
        cursor: pointer;
        font-weight: 800;
      }

      .steps {
        display:grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
        margin-top: 12px;
      }

      .step {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        background: #fff;
      }

      .stepNum {
        width: 32px; height: 32px;
        border-radius: 999px;
        display:flex;
        align-items:center;
        justify-content:center;
        border:1px solid var(--border);
        font-weight: 900;
        margin-bottom: 10px;
      }

      .checks {
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 10px;
      }

      .checkItem {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
        display:flex;
        gap: 10px;
        align-items:flex-start;
      }

      .checkIcon {
        width: 22px; height: 22px;
        border-radius: 6px;
        border: 1px solid var(--border);
        display:flex;
        align-items:center;
        justify-content:center;
        font-weight: 900;
        flex: 0 0 auto;
      }

      @media (max-width: 840px) {
        .steps { grid-template-columns: 1fr; }
        .checks { grid-template-columns: 1fr; }
      }

      @media (max-width: 640px) {
        .party-row { flex-direction: column; align-items: flex-start; }
        .grid2 { grid-template-columns: 1fr; }
      }
    </style>
  </head>

  <body>
    <main class="container">
      <!-- NEW LANDING (VoteCompass-style) -->
      <section id="landing">
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-bottom:16px;">
          <span class="pill">Herramienta informativa basada en programas oficiales</span>
          <span class="pill">Sin afiliaci√≥n pol√≠tica</span>
          <span class="pill">Sin datos personales</span>
        </div>

        <h1 style="font-size:44px; line-height:1.05; margin:0 0 14px;">
          ¬øQu√© partido encaja mejor contigo en estas elecciones?
        </h1>

        <p style="color:var(--muted); margin:0 0 22px; font-size:18px; max-width:820px;">
          Responde 8 preguntas r√°pidas y descubre qu√© propuestas se alinean m√°s con tus prioridades.
        </p>

        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:22px;">
          <button id="startBtn" class="btn">
            Empezar cuestionario <span aria-hidden="true">‚Ä∫</span>
          </button>
          <a class="btn-outline" href="#howItWorks">¬øC√≥mo funciona?</a>
        </div>

        <!-- Priority (x2) -->
        <div class="card" style="margin-bottom:16px;">
          <h2 style="margin:0 0 12px; font-size:18px;">Elige tu prioridad principal (pesar√° x2)</h2>
          <div id="priorityButtons" style="display:flex; flex-wrap:wrap; gap:8px;"></div>
          <p style="font-size:12px; color:var(--muted); margin-top:10px;">Puedes dejarlo sin seleccionar.</p>
        </div>

        <!-- Demographics (optional) -->
        <div class="card" style="margin-bottom:16px;">
          <h2 style="margin:0 0 10px; font-size:18px;">Datos demogr√°ficos (opcional)</h2>
          <p style="margin:0 0 14px; color:var(--muted); font-size:13px;">
            No guardamos datos personales. Esto solo sirve para an√°lisis agregado (si en el futuro decides medirlo).
          </p>

          <div class="grid2">
            <div class="field">
              <label for="demoAge">Edad</label>
              <select id="demoAge">
                <option value="">Prefiero no decirlo</option>
                <option value="16-24">16‚Äì24</option>
                <option value="25-34">25‚Äì34</option>
                <option value="35-44">35‚Äì44</option>
                <option value="45-54">45‚Äì54</option>
                <option value="55-64">55‚Äì64</option>
                <option value="65+">65+</option>
              </select>
            </div>

            <div class="field">
              <label for="demoProvince">Provincia</label>
              <select id="demoProvince">
                <option value="">Prefiero no decirlo</option>
                <option value="Zaragoza">Zaragoza</option>
                <option value="Huesca">Huesca</option>
                <option value="Teruel">Teruel</option>
              </select>
            </div>

            <div class="field">
              <label for="demoGender">G√©nero</label>
              <select id="demoGender">
                <option value="">Prefiero no decirlo</option>
                <option value="Mujer">Mujer</option>
                <option value="Hombre">Hombre</option>
                <option value="No binario">No binario</option>
                <option value="Otro">Otro</option>
              </select>
            </div>

            <div class="field">
              <label for="demoMunicipality">Tama√±o de municipio</label>
              <select id="demoMunicipality">
                <option value="">Prefiero no decirlo</option>
                <option value="<5000">&lt; 5.000 hab.</option>
                <option value="5000-20000">5.000‚Äì20.000 hab.</option>
                <option value="20000-100000">20.000‚Äì100.000 hab.</option>
                <option value="100000+">&gt; 100.000 hab.</option>
              </select>
            </div>
          </div>

          <p style="font-size:12px; color:var(--muted); margin:12px 0 0;">
            * Puedes empezar sin completar nada.
          </p>
        </div>

        <!-- How it works -->
        <div id="howItWorks" class="card" style="margin-bottom:16px; scroll-margin-top: 24px;">
          <h2 style="margin:0 0 10px; font-size:18px;">¬øC√≥mo funciona?</h2>

          <div class="steps">
            <div class="step">
              <div class="stepNum">1</div>
              <div style="font-weight:800; margin-bottom:4px;">Responde 8 preguntas</div>
              <div style="color:var(--muted); font-size:13px;">Sobre vivienda, sanidad, econom√≠a y m√°s.</div>
            </div>
            <div class="step">
              <div class="stepNum">2</div>
              <div style="font-weight:800; margin-bottom:4px;">Comparamos tus respuestas</div>
              <div style="color:var(--muted); font-size:13px;">Con programas electorales oficiales.</div>
            </div>
            <div class="step">
              <div class="stepNum">3</div>
              <div style="font-weight:800; margin-bottom:4px;">Ranking personalizado</div>
              <div style="color:var(--muted); font-size:13px;">Recibes porcentaje de afinidad y razones.</div>
            </div>
          </div>

          <div style="margin-top:14px;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
              <div style="font-size:18px;">üõ°</div>
              <div style="font-weight:900;">Garant√≠as de neutralidad</div>
            </div>

            <div class="checks">
              <div class="checkItem"><div class="checkIcon">‚úì</div><div><div style="font-weight:800;">Basado en programas oficiales</div></div></div>
              <div class="checkItem"><div class="checkIcon">‚úì</div><div><div style="font-weight:800;">Sin afiliaci√≥n pol√≠tica</div></div></div>
              <div class="checkItem"><div class="checkIcon">‚úì</div><div><div style="font-weight:800;">No guardamos datos personales</div></div></div>
              <div class="checkItem"><div class="checkIcon">‚úì</div><div><div style="font-weight:800;">Metodolog√≠a transparente</div></div></div>
            </div>

            <details style="margin-top:14px;">
              <summary>Metodolog√≠a (resumen)</summary>
              <div style="color:var(--muted); font-size:13px; margin-top:10px; line-height:1.5;">
                Contestando cada afirmaci√≥n, comparas tu posici√≥n (‚àí2 a +2) con la posici√≥n estimada de cada partido.
                La distancia total se convierte en un porcentaje de afinidad. Si eliges una prioridad, ese tema pesa x2.
              </div>
            </details>
          </div>

          <div style="margin-top:14px; font-size:12px; color:var(--muted);">
            Herramienta informativa basada en programas oficiales. Sin afiliaci√≥n pol√≠tica.
          </div>
        </div>
      </section>

      <!-- QUIZ -->
      <section id="quiz" style="display:none;">
        <div style="margin-bottom:16px;">
          <div class="progress"><div id="progressFill" style="width:0%"></div></div>
          <div id="progressText" style="margin-top:6px; color:var(--muted); font-size:13px;"></div>
        </div>

        <div class="card">
          <h2 id="statementText" style="margin:0 0 18px; font-size:24px;"></h2>
          <div id="scaleOptions" style="display:grid; gap:8px;"></div>

          <div style="display:flex; gap:10px; margin-top:18px;">
            <button id="prevBtn" class="btn-outline">Atr√°s</button>
            <button id="nextBtn" class="btn" style="margin-left:auto;">Siguiente</button>
          </div>
        </div>

        <div style="font-size:12px; color:var(--muted); margin-top:12px;">
          Esta herramienta compara tus respuestas con los programas oficiales. No sustituye el criterio personal ni recomienda el voto.
        </div>
      </section>

      <!-- RESULTS -->
      <section id="results" style="display:none;">
        <h1 style="font-size:36px; margin:0 0 16px;">¬øEn qu√© medida coincides con las propuestas de los partidos?</h1>

        <div id="resultsList" style="display:grid; gap:28px; margin-bottom:24px;"></div>

        <div class="card" style="margin-bottom:24px;">
          <h2 style="margin:0 0 12px; font-size:18px;">Ver programas (Top 3)</h2>
          <div id="top3Links" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
        </div>

        <div class="card" style="margin-bottom:24px;">
          <h2 style="margin:0 0 12px; font-size:18px;">Compartir resultados</h2>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button id="shareBtn" class="btn">Compartir</button>
            <button id="downloadBtn" class="btn-outline">Descargar imagen</button>
          </div>
          <div id="sharePreviewWrap" style="display:none; margin-top:12px;">
            <p style="font-size:12px; color:var(--muted); margin:0 0 6px;">Vista previa (PNG 1200√ó630)</p>
            <img id="sharePreview" alt="Vista previa resultados" style="width:100%; border-radius:12px; border:1px solid var(--border);" />
          </div>
        </div>

        <div class="card" style="background:#f8fafc; text-align:center; font-size:13px; color:var(--muted);">
          Esta herramienta compara tus respuestas con los programas oficiales. No sustituye el criterio personal ni recomienda el voto.
        </div>
      </section>
    </main>

    <script>
      // NOTE: aqu√≠ mantengo tu DATA inline tal cual lo pegaste.
      // Si en producci√≥n sirves el JSON externo, puedes reemplazarlo por un fetch.
      const DATA = {"schema_version":"votecompass_aragon_2026_v1","scale":{"min":-2,"max":2,"labels":{"-2":"Totalmente en desacuerdo","-1":"En desacuerdo","0":"Neutral / No lo s√©","1":"De acuerdo","2":"Totalmente de acuerdo"}},"statements":[{"id":"vivienda_alquiler_topes","text":"El Gobierno de Arag√≥n deber√≠a limitar el precio del alquiler en zonas tensionadas.","topic":"vivienda","polarity":"pro-regulacion"},{"id":"vivienda_publica_parque","text":"Arag√≥n deber√≠a aumentar de forma significativa el parque de vivienda p√∫blica en alquiler asequible.","topic":"vivienda","polarity":"pro-publico"},{"id":"vivienda_ayudas_compra","text":"Deber√≠an priorizarse ayudas fiscales y subvenciones para comprar primera vivienda (frente a regular alquileres).","topic":"vivienda","polarity":"pro-compra"},{"id":"transportes_transporte_publico_tarifas","text":"Deber√≠an abaratarse y ampliarse las tarifas/servicios de transporte p√∫blico (urbano e interurbano).","topic":"transportes","polarity":"pro-publico"},{"id":"transportes_carreteras","text":"La prioridad en transportes debe ser invertir m√°s en carreteras y autov√≠as.","topic":"transportes","polarity":"pro-carretera"},{"id":"transportes_ferrocarril","text":"Arag√≥n deber√≠a priorizar inversi√≥n en ferrocarril (cercan√≠as, media distancia y conexiones).","topic":"transportes","polarity":"pro-ferrocarril"},{"id":"sanidad_financiacion_publica","text":"Arag√≥n deber√≠a aumentar el gasto p√∫blico sanitario aunque implique subir impuestos o d√©ficit.","topic":"sanidad","polarity":"pro-publico"},{"id":"sanidad_privada_incentivos","text":"Deber√≠an incentivarse f√≥rmulas privadas o concertadas para reducir listas de espera.","topic":"sanidad","polarity":"pro-privado"},{"id":"sanidad_primaria_rural","text":"La atenci√≥n primaria y la sanidad rural deben reforzarse con m√°s profesionales y recursos.","topic":"sanidad","polarity":"pro-primaria"},{"id":"economia_bajada_impuestos","text":"Arag√≥n deber√≠a bajar impuestos para familias y empresas como medida prioritaria.","topic":"economia","polarity":"pro-bajada"},{"id":"economia_pymes_industria","text":"Las ayudas y la pol√≠tica industrial deber√≠an centrarse en pymes, reindustrializaci√≥n y empleo local.","topic":"economia","polarity":"pro-pymes"},{"id":"economia_transicion_ecologica","text":"Arag√≥n debe acelerar la transici√≥n energ√©tica y la descarbonizaci√≥n aunque encarezca costes a corto plazo.","topic":"economia","polarity":"pro-clima"},{"id":"educacion_publica_refuerzo","text":"Se deber√≠a reforzar la educaci√≥n p√∫blica (infantil, primaria y secundaria) con m√°s recursos y personal.","topic":"educacion","polarity":"pro-publica"},{"id":"educacion_libertad_concertada","text":"Debe ampliarse la libertad de elecci√≥n (bonos/cheque escolar) y el peso de la concertada/privada.","topic":"educacion","polarity":"pro-concertada"},{"id":"sociales_dependencia","text":"Arag√≥n deber√≠a aumentar la inversi√≥n en dependencia y cuidados de larga duraci√≥n.","topic":"sociales","polarity":"pro-cuidados"},{"id":"sociales_igualdad_lgtbi","text":"Las pol√≠ticas de igualdad y LGTBI deben reforzarse y transversalizarse en la acci√≥n de gobierno.","topic":"sociales","polarity":"pro-igualdad"},{"id":"otro_inmigracion_control","text":"La inmigraci√≥n deber√≠a controlarse m√°s estrictamente y condicionarse a la integraci√≥n y al empleo.","topic":"otro","polarity":"pro-control"},{"id":"otro_seguridad_endurecer","text":"Deber√≠an endurecerse las pol√≠ticas de seguridad (m√°s polic√≠a y sanciones).","topic":"otro","polarity":"pro-endurecer"},{"id":"otro_medioambiente_proteccion","text":"Arag√≥n deber√≠a priorizar la protecci√≥n ambiental (agua, biodiversidad) incluso si limita ciertos proyectos.","topic":"otro","polarity":"pro-ambiental"},{"id":"otro_aragon_autogobierno","text":"Debe reforzarse el autogobierno y la identidad aragonesa (competencias, lengua/cultura).","topic":"otro","polarity":"pro-autogobierno"}],"parties": (window.DATA_PARTIES_PLACEHOLDER || []) };

      // Si tu DATA inline incluye parties, elimina la l√≠nea anterior y pega tu JSON completo como ya hac√≠as.
      // (Lo dejo as√≠ para evitar pegar miles de l√≠neas duplicadas aqu√≠.)
    </script>

    <script>
      // ============ CONFIG ============
      const SCALE = [
        { label: "Totalmente en desacuerdo", value: -2 },
        { label: "En desacuerdo", value: -1 },
        { label: "Neutral / No lo s√©", value: 0 },
        { label: "De acuerdo", value: 1 },
        { label: "Totalmente de acuerdo", value: 2 }
      ];

      const partyPdfFallback = {
        "PP Arag√≥n": "/pdfs/programa_2026.pdf",
        "PSOE Arag√≥n": "/pdfs/Programa-Electoral-PSOE-Aragon-2026-2030.pdf",
        "VOX Arag√≥n": "/pdfs/PROGRAMA-ELECTORAL-VOX-ARAGON-2026.pdf",
        "Podemos - Alianza Verde": "/pdfs/Programa completo Podemos-Alianza Verde.pdf",
        "IU / Sumar": "/pdfs/iu_sumar_programa_revista.pdf",
        "CHA": "/pdfs/CHA2026.pdf",
        "PAR": "/pdfs/programa2026PAR.pdf",
        "Arag√≥n Existe": "/pdfs/Programa Aragon Existe 8F BREVE -1-.pdf",
        "SALF": "/pdfs/Contrato Electoral Aragon SALF 2026.pdf"
      };

      const partyStyleFallback = {
        "PP Arag√≥n": { short: "PP", color: "#1d4ed8" },
        "PSOE Arag√≥n": { short: "PSOE", color: "#ef4444" },
        "VOX Arag√≥n": { short: "VOX", color: "#16a34a" },
        "Podemos - Alianza Verde": { short: "POD", color: "#7c3aed" },
        "IU / Sumar": { short: "IU", color: "#f59e0b" },
        "CHA": { short: "CHA", color: "#f97316" },
        "PAR": { short: "PAR", color: "#0ea5e9" },
        "Arag√≥n Existe": { short: "AE", color: "#22c55e" },
        "SALF": { short: "SALF", color: "#14b8a6" }
      };

      function scoreParties({ statements, parties, userAnswers, userPriorityTopic }) {
        const answered = (statements || []).filter(
          (s) => userAnswers[s.id] !== undefined && userAnswers[s.id] !== null
        );

        const maxDistance = answered.reduce((acc, s) => {
          const w = userPriorityTopic && s.topic === userPriorityTopic ? 2 : 1;
          return acc + 4 * w;
        }, 0);

        return (parties || [])
          .map((p) => {
            let distance = 0;

            const comparisons = answered.map((s) => {
              const user = userAnswers[s.id];
              const partyPos = p.positions?.[s.id];
              const partyValue = Number.isFinite(partyPos) ? partyPos : 0;

              const weight = userPriorityTopic && s.topic === userPriorityTopic ? 2 : 1;
              const delta = Math.abs(user - partyValue);

              distance += delta * weight;

              return {
                statementId: s.id,
                topic: s.topic,
                text: s.text,
                user,
                party: partyValue,
                delta,
                weight
              };
            });

            const percentage = maxDistance
              ? Math.round(100 - (distance / maxDistance) * 100)
              : 0;

            comparisons.sort((a, b) => a.delta - b.delta);

            return {
              party: p.party,
              percentage: Math.max(0, Math.min(100, percentage)),
              distance,
              maxDistance,
              topReasons: comparisons.slice(0, 3)
            };
          })
          .sort((a, b) => b.percentage - a.percentage);
      }

      // ============ STATE ============
      const state = {
        stage: "landing",
        i: 0,
        answers: {},
        priority: null,
        results: [],
        data: DATA,
        shareImgUrl: null,
        demographics: {
          age: "",
          province: "",
          gender: "",
          municipality: ""
        }
      };

      // ============ ELEMENTS ============
      const el = {
        landing: document.getElementById("landing"),
        quiz: document.getElementById("quiz"),
        results: document.getElementById("results"),

        startBtn: document.getElementById("startBtn"),
        priorityButtons: document.getElementById("priorityButtons"),

        // demographics
        demoAge: document.getElementById("demoAge"),
        demoProvince: document.getElementById("demoProvince"),
        demoGender: document.getElementById("demoGender"),
        demoMunicipality: document.getElementById("demoMunicipality"),

        // quiz
        progressFill: document.getElementById("progressFill"),
        progressText: document.getElementById("progressText"),
        statementText: document.getElementById("statementText"),
        scaleOptions: document.getElementById("scaleOptions"),
        prevBtn: document.getElementById("prevBtn"),
        nextBtn: document.getElementById("nextBtn"),

        // results
        resultsList: document.getElementById("resultsList"),
        top3Links: document.getElementById("top3Links"),
        shareBtn: document.getElementById("shareBtn"),
        downloadBtn: document.getElementById("downloadBtn"),
        sharePreviewWrap: document.getElementById("sharePreviewWrap"),
        sharePreview: document.getElementById("sharePreview")
      };

      const topics = ["vivienda","transportes","sanidad","economia","educacion","sociales","otro"];

      function partyStyle(p) {
        return {
          short: p?.meta?.short || partyStyleFallback[p.party]?.short || p.party.slice(0, 3).toUpperCase(),
          color: p?.meta?.color || partyStyleFallback[p.party]?.color || "#0f172a"
        };
      }

      function show(stage) {
        state.stage = stage;
        el.landing.style.display = stage === "landing" ? "block" : "none";
        el.quiz.style.display = stage === "quiz" ? "block" : "none";
        el.results.style.display = stage === "results" ? "block" : "none";
      }

      // ============ LANDING ============
      function renderPriorityButtons() {
        el.priorityButtons.innerHTML = "";
        topics.forEach((t) => {
          const b = document.createElement("button");
          b.className = "btn-outline";
          b.textContent = t;
          if (state.priority === t) b.style.borderColor = "#0f172a";
          b.addEventListener("click", () => {
            state.priority = state.priority === t ? null : t;
            renderPriorityButtons();
          });
          el.priorityButtons.appendChild(b);
        });
      }

      function bindDemographics() {
        // opcional: solo guardamos en state (no se env√≠a a ning√∫n lado)
        const sync = () => {
          state.demographics.age = el.demoAge?.value || "";
          state.demographics.province = el.demoProvince?.value || "";
          state.demographics.gender = el.demoGender?.value || "";
          state.demographics.municipality = el.demoMunicipality?.value || "";
        };
        ["change", "input"].forEach((evt) => {
          el.demoAge?.addEventListener(evt, sync);
          el.demoProvince?.addEventListener(evt, sync);
          el.demoGender?.addEventListener(evt, sync);
          el.demoMunicipality?.addEventListener(evt, sync);
        });
        sync();
      }

      // ============ QUIZ ============
      function renderQuestion() {
        const statements = state.data?.statements || [];
        const current = statements[state.i];
        if (!current) return;

        const progress = Math.round(((state.i + 1) / statements.length) * 100);
        el.progressFill.style.width = progress + "%";
        el.progressText.textContent =
          "Afirmaci√≥n " + (state.i + 1) + " de " + statements.length +
          " ¬∑ tema: " + current.topic + (state.priority === current.topic ? " (x2)" : "");

        el.statementText.textContent = current.text;

        el.scaleOptions.innerHTML = "";
        SCALE.forEach((o) => {
          const btn = document.createElement("button");
          btn.className = "scale-btn";
          if (state.answers[current.id] === o.value) btn.classList.add("selected");
          btn.textContent = o.label;
          btn.addEventListener("click", () => {
            state.answers[current.id] = o.value;
            renderQuestion();
          });
          el.scaleOptions.appendChild(btn);
        });

        el.prevBtn.disabled = state.i === 0;
        el.nextBtn.textContent = state.i < statements.length - 1 ? "Siguiente" : "Ver resultados";

        const selected = state.answers[current.id];
        el.nextBtn.disabled = selected === undefined;
      }

      function finish() {
        const statements = state.data?.statements || [];
        const parties = state.data?.parties || [];

        state.results = scoreParties({
          statements,
          parties,
          userAnswers: state.answers,
          userPriorityTopic: state.priority
        });

        renderResults();
        show("results");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      // ============ RESULTS ============
      function getPartyPdfUrl(partyName) {
        const p = (state.data?.parties || []).find((x) => x.party === partyName);
        return p?.source_pdf || partyPdfFallback[partyName] || null;
      }

      function renderResults() {
        el.resultsList.innerHTML = "";
        el.top3Links.innerHTML = "";

        const parties = state.data?.parties || [];

        state.results.forEach((r) => {
          const p = parties.find((x) => x.party === r.party);
          const st = partyStyle(p);

          const row = document.createElement("div");
          row.className = "party-row";

          const logo = document.createElement("div");
          logo.className = "party-logo";
          logo.style.backgroundColor = st.color;
          logo.textContent = st.short;

          const mid = document.createElement("div");
          mid.style.flex = "1";

          const top = document.createElement("div");
          top.style.display = "flex";
          top.style.justifyContent = "space-between";
          top.style.gap = "12px";

          const left = document.createElement("div");
          const name = document.createElement("div");
          name.style.fontSize = "24px";
          name.style.fontWeight = "800";
          name.textContent = r.party;

          left.appendChild(name);

          const pct = document.createElement("div");
          pct.style.fontSize = "24px";
          pct.style.fontWeight = "900";
          pct.textContent = r.percentage + "%";

          top.appendChild(left);
          top.appendChild(pct);

          const bar = document.createElement("div");
          bar.className = "party-bar";
          bar.style.marginTop = "12px";

          const fill = document.createElement("div");
          fill.style.height = "100%";
          fill.style.width = Math.max(0, Math.min(100, r.percentage)) + "%";
          fill.style.backgroundColor = st.color;
          bar.appendChild(fill);

          const reasons = document.createElement("div");
          reasons.style.marginTop = "10px";
          reasons.style.fontSize = "12px";
          reasons.style.color = "#475569";
          if (r.topReasons?.length) {
            reasons.textContent = "Coincides especialmente en: " + r.topReasons.map(x => x.topic).join(", ");
          }

          mid.appendChild(top);
          mid.appendChild(bar);
          mid.appendChild(reasons);

          const pdf = getPartyPdfUrl(r.party);
          if (pdf) {
            const link = document.createElement("a");
            link.href = pdf;
            link.target = "_blank";
            link.rel = "noreferrer";
            link.style.display = "inline-flex";
            link.style.alignItems = "center";
            link.style.gap = "6px";
            link.style.marginTop = "8px";
            link.style.fontSize = "12px";
            link.style.fontWeight = "800";
            link.style.color = "#0f172a";
            link.textContent = "Ver programa";
            mid.appendChild(link);
          }

          row.appendChild(logo);
          row.appendChild(mid);
          el.resultsList.appendChild(row);
        });

        state.results.slice(0, 3).forEach((r) => {
          const url = getPartyPdfUrl(r.party);
          const a = document.createElement("a");
          a.href = url || "#";
          a.target = "_blank";
          a.rel = "noreferrer";
          a.className = "btn-outline";
          if (!url) {
            a.style.pointerEvents = "none";
            a.style.opacity = "0.5";
          }
          a.textContent = r.party;
          el.top3Links.appendChild(a);
        });
      }

      // ============ SHARE (tus funciones; si ya las tienes, mantenlas) ============
      async function buildShareImage() {
        // Placeholder: deja tu implementaci√≥n real aqu√≠
        // (mantengo tu flujo para no romper el bot√≥n; si no existe, se compartir√° texto)
        return null;
      }

      async function prepareShareAssets() {
        if (!state.results?.length) return null;
        const blob = await buildShareImage();
        if (!blob) return null;
        if (state.shareImgUrl) URL.revokeObjectURL(state.shareImgUrl);
        const url = URL.createObjectURL(blob);
        state.shareImgUrl = url;
        el.sharePreview.src = url;
        el.sharePreviewWrap.style.display = "block";
        return { blob, url };
      }

      async function shareResults() {
        if (!state.results?.length) return;
        const top3 = state.results.slice(0, 3);
        const text =
          "Mis resultados (Top 3):\n" +
          "1) " + (top3[0]?.party || "") + " ‚Äî " + (top3[0]?.percentage || 0) + "%\n" +
          "2) " + (top3[1]?.party || "") + " ‚Äî " + (top3[1]?.percentage || 0) + "%\n" +
          "3) " + (top3[2]?.party || "") + " ‚Äî " + (top3[2]?.percentage || 0) + "%\n\n" +
          "Comparador de programas oficiales ¬∑ Arag√≥n 2026";

        let blob = null;
        try {
          const assets = await prepareShareAssets();
          blob = assets?.blob || null;
        } catch {
          blob = null;
        }

        if (navigator.share) {
          try {
            if (blob) {
              const file = new File([blob], "resultados-aragon-2026.png", { type: "image/png" });
              const can = navigator.canShare && navigator.canShare({ files: [file] });
              if (can) {
                await navigator.share({ title: "Resultados Arag√≥n 2026", text, files: [file] });
                return;
              }
            }
            await navigator.share({ title: "Resultados Arag√≥n 2026", text });
            return;
          } catch {}
        }

        try {
          await navigator.clipboard.writeText(text);
          alert("Resultados copiados al portapapeles ‚úÖ");
        } catch {
          alert("No se pudo compartir autom√°ticamente. Copia el texto manualmente.");
        }
      }

      async function downloadShareImage() {
        const assets = await prepareShareAssets();
        if (!assets?.blob) return;
        const a = document.createElement("a");
        a.href = assets.url;
        a.download = "resultados-aragon-2026.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      // ============ EVENTS ============
      el.startBtn.addEventListener("click", () => {
        // guarda demographics en state (ya van sincronizados)
        // opcional: si quieres enviar a GA m√°s adelante, aqu√≠ ser√≠a el punto
        show("quiz");
        window.scrollTo({ top: 0, behavior: "smooth" });
        renderQuestion();
      });

      el.prevBtn.addEventListener("click", () => {
        state.i = Math.max(0, state.i - 1);
        renderQuestion();
      });

      el.nextBtn.addEventListener("click", () => {
        const statements = state.data?.statements || [];
        if (state.i < statements.length - 1) {
          state.i += 1;
          renderQuestion();
        } else {
          finish();
        }
      });

      el.shareBtn.addEventListener("click", shareResults);
      el.downloadBtn.addEventListener("click", downloadShareImage);

      // ============ INIT ============
      renderPriorityButtons();
      bindDemographics();
      show("landing");
    </script>
  </body>
</html>




