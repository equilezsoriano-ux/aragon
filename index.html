<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cuestionario Electoral - Aragon 2026</title>
    <style>
      :root {
        --bg-top: #f8fafc;
        --bg-bottom: #e2e8f0;
        --text: #0f172a;
        --muted: #64748b;
        --card: #ffffff;
        --accent: #1f2937;
        --accent-hover: #374151;
        --border: #e2e8f0;
        --shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", system-ui, -apple-system, sans-serif;
        color: var(--text);
        background: linear-gradient(180deg, var(--bg-top), var(--bg-bottom));
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 64px 20px 96px;
      }

      .center { text-align: center; }

      .hero h1 {
        font-size: clamp(28px, 5vw, 48px);
        margin: 0 0 16px;
        line-height: 1.1;
      }

      .hero p {
        font-size: clamp(16px, 2.5vw, 20px);
        color: var(--muted);
        margin: 0 0 24px;
      }

      .cta {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: var(--accent);
        color: #fff;
        padding: 14px 24px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        transition: background 0.2s ease;
        border: none;
        cursor: pointer;
      }

      .cta:hover { background: var(--accent-hover); }

      .cta:disabled { background: #94a3b8; cursor: not-allowed; }

      .note {
        margin-top: 12px;
        font-size: 13px;
        color: var(--muted);
      }

      .card {
        background: var(--card);
        border-radius: 16px;
        box-shadow: var(--shadow);
        padding: 32px;
      }

      .how { margin-bottom: 48px; }

      .how h2,
      .neutral h2 {
        margin: 0 0 24px;
        text-align: center;
        font-size: 24px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 24px;
      }

      .step { text-align: center; }

      .icon {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: #f1f5f9;
        display: grid;
        place-items: center;
        margin: 0 auto 12px;
        font-weight: 700;
        color: #334155;
      }

      .step h3 { margin: 0 0 6px; font-size: 16px; }
      .step p { margin: 0; color: var(--muted); font-size: 14px; }

      .neutral {
        background: #111827;
        color: #fff;
        border-radius: 16px;
        padding: 28px;
      }

      .neutral h2 {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        font-size: 22px;
      }

      .neutral ul {
        list-style: none;
        margin: 0;
        padding: 0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
      }

      .neutral li {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        color: #e2e8f0;
        font-size: 14px;
      }

      .check { font-weight: 700; }

      .progress { margin-bottom: 24px; }

      .progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 999px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #1f2937;
        width: 0%;
        transition: width 0.3s ease;
      }

      .question-title {
        font-size: 22px;
        margin: 0 0 18px;
      }

      .options { display: grid; gap: 10px; }

      .option-btn {
        text-align: left;
        padding: 14px 16px;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        background: #fff;
        font-weight: 600;
        color: #0f172a;
        cursor: pointer;
        transition: border 0.2s ease, background 0.2s ease;
      }

      .option-btn:hover { border-color: #1f2937; background: #f8fafc; }
      .option-btn.selected { border-color: #1f2937; background: #f8fafc; }

      .form-grid { display: grid; gap: 16px; }

      label { font-size: 14px; font-weight: 600; color: #334155; }

      select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 2px solid #e2e8f0;
        background: #fff;
        font-size: 14px;
      }

      .loading {
        display: grid;
        place-items: center;
        min-height: 60vh;
        text-align: center;
      }

      .spinner {
        width: 56px;
        height: 56px;
        border: 4px solid #e2e8f0;
        border-top-color: #1f2937;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 16px;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

      .result-card {
        background: #fff;
        border-radius: 16px;
        padding: 20px;
        box-shadow: var(--shadow);
      }

      .result-head {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      .badge { font-size: 28px; }

      .muted { color: var(--muted); }

      .tag-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 6px; }

      .tag-list li { font-size: 14px; color: #475569; }

      .result-footer { margin-top: 12px; }

      .link {
        color: #1f2937;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
      }

      .link:hover { color: #374151; }

      .small { font-size: 13px; color: var(--muted); }

      .hidden { display: none; }

      @media (max-width: 600px) {
        .container { padding: 48px 16px 72px; }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <!-- LANDING -->
      <section id="landing" class="hero center">
        <h1>Â¿QuÃ© partido encaja mejor contigo en estas elecciones?</h1>
        <p>Responde 8 preguntas rÃ¡pidas y descubre quÃ© propuestas se alinean mÃ¡s con tus prioridades.</p>
        <button id="startBtn" class="cta">Empezar cuestionario <span aria-hidden="true">â€º</span></button>
        <div class="note">Herramienta informativa basada en programas oficiales. Sin afiliaciÃ³n polÃ­tica.</div>

        <div class="card how" style="margin-top:48px;">
          <h2>Â¿CÃ³mo funciona?</h2>
          <div class="grid">
            <div class="step">
              <div class="icon">1</div>
              <h3>Responde 8 preguntas</h3>
              <p>Sobre vivienda, sanidad, economÃ­a y mÃ¡s.</p>
            </div>
            <div class="step">
              <div class="icon">2</div>
              <h3>Comparamos tus respuestas</h3>
              <p>Con programas electorales oficiales.</p>
            </div>
            <div class="step">
              <div class="icon">3</div>
              <h3>Ranking personalizado</h3>
              <p>Recibes porcentaje de afinidad y razones.</p>
            </div>
          </div>
        </div>

        <div class="neutral">
          <h2><span aria-hidden="true">ðŸ›¡</span> Garantias de neutralidad</h2>
          <ul>
            <li><span class="check">âœ“</span>Basado en programas oficiales</li>
            <li><span class="check">âœ“</span>Sin afiliacion politica</li>
            <li><span class="check">âœ“</span>No guardamos datos personales</li>
            <li><span class="check">âœ“</span>Metodologia transparente</li>
          </ul>
        </div>
      </section>

      <!-- QUIZ -->
      <section id="quiz" class="hidden">
        <div class="progress">
          <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
          </div>
          <div id="progressText" class="small" style="text-align:center; margin-top:8px;">Pregunta 1 de 8</div>
        </div>

        <div class="card">
          <h2 id="questionTitle" class="question-title"></h2>
          <p id="questionHelp" class="small" style="margin-top:-8px; margin-bottom:18px;"></p>
          <p id="multiHelp" class="small hidden" style="margin-top:-8px; margin-bottom:18px;"></p>

          <div id="demographicForm" class="form-grid hidden"></div>
          <div id="options" class="options"></div>
          <button id="multiContinue" class="cta hidden" style="margin-top:16px;">Continuar</button>
        </div>
      </section>

      <!-- LOADING -->
      <section id="loading" class="hidden loading">
        <div>
          <div class="spinner"></div>
          <div class="muted" style="font-size:18px;">Analizando tu perfil y comparÃ¡ndolo con los programas electorales...</div>
        </div>
      </section>

      <!-- RESULTS -->
      <section id="results" class="hidden">
        <div class="center" style="margin-bottom:32px;">
          <h1 style="margin-bottom:8px;">Tus resultados</h1>
          <p class="muted">Basados en la comparaciÃ³n con los programas electorales oficiales</p>
        </div>

        <div id="resultsList" class="grid" style="grid-template-columns: 1fr; gap:16px; margin-bottom:24px;"></div>

        <div class="card center" style="background:#f1f5f9;">
          <p class="small">Esta herramienta compara tus respuestas con los programas oficiales. No sustituye el criterio personal ni recomienda el voto.</p>
        </div>

        <div class="center" style="margin-top:24px;">
          <button id="restartBtn" class="cta" style="background:#334155;">Volver a empezar</button>
        </div>
      </section>
    </main>

    <script src="./program-data.js"></script>
    <script>
      const JSON_URL = "./aragon_2026_programas_structured.json";
      const MAX_MULTI = 2;
      const PRIORITY_MULTIPLIER = 2;

      const partyPdfFallback = {
        "PP AragÃ³n": "/pdfs/programa_2026.pdf",
        "PSOE AragÃ³n": "/pdfs/Programa-Electoral-PSOE-Aragon-2026-2030.pdf",
        "VOX AragÃ³n": "/pdfs/PROGRAMA-ELECTORAL-VOX-ARAGON-2026.pdf",
        "Podemos - Alianza Verde": "/pdfs/Programa completo Podemos-Alianza Verde.pdf",
        "IU / Sumar": "/pdfs/iu_sumar_programa_revista.pdf",
        "CHA": "/pdfs/CHA2026.pdf",
        "PAR": "/pdfs/programa2026PAR.pdf",
        "Partido AragonÃ©s (PAR)": "/pdfs/programa2026PAR.pdf",
        "AragÃ³n Existe": "/pdfs/Programa Aragon Existe 8F BREVE -1-.pdf",
        "SALF": "/pdfs/Contrato Electoral Aragon SALF 2026.pdf",
        "SALF (Se AcabÃ³ La Fiesta)": "/pdfs/Contrato Electoral Aragon SALF 2026.pdf"
      };

      const prefixLabel = {
        vivienda: "Vivienda",
        transportes: "Transportes",
        sanidad: "Sanidad",
        economia: "EconomÃ­a y empleo",
        educacion: "EducaciÃ³n",
        sociales: "PolÃ­ticas sociales",
        otro: "Otro"
      };

      const labelMap = {
        "vivienda.control_alquiler": "Control del precio del alquiler",
        "vivienda.vivienda_publica": "ConstrucciÃ³n de vivienda pÃºblica",
        "vivienda.ayudas_compra": "Ayudas a compra de primera vivienda",
        "vivienda.proteccion_propietario": "ProtecciÃ³n a propietarios",
        "vivienda.regulacion_turistica": "RegulaciÃ³n turÃ­stica",

        "transportes.transporte_publico_barato": "Transporte pÃºblico mÃ¡s barato",
        "transportes.carreteras_inversion": "MÃ¡s inversiÃ³n en carreteras",
        "transportes.movilidad_sostenible": "Movilidad sostenible",
        "transportes.infraestructura_rural": "Infraestructura rural",
        "transportes.ferrocarril_inversion": "MÃ¡s inversiÃ³n en ferrocarril (cercanÃ­as/medio recorrido)",

        "sanidad.listas_espera": "Reducir listas de espera",
        "sanidad.mas_inversion_publica": "MÃ¡s inversiÃ³n pÃºblica",
        "sanidad.colaboracion_publico_privada": "ColaboraciÃ³n pÃºblico-privada",
        "sanidad.atencion_primaria": "Refuerzo de atenciÃ³n primaria",
        "sanidad.financiacion_privada": "Incentivos a seguros/financiaciÃ³n privada (complementaria)",

        "economia.bajada_impuestos": "Bajada de impuestos",
        "economia.apoyo_pymes": "Apoyo a pymes",
        "economia.empleo_publico": "CreaciÃ³n de empleo pÃºblico",
        "economia.atraccion_inversion": "AtracciÃ³n de inversiÃ³n",
        "economia.proteccion_laboral": "ProtecciÃ³n laboral",

        "educacion.educacion_publica": "EducaciÃ³n pÃºblica",
        "educacion.cheque_escolar": "Cheque escolar",
        "educacion.financiacion_privada": "MÃ¡s peso a concertada/privada (financiaciÃ³n/bonos)",

        "sociales.igualdad": "PolÃ­ticas de igualdad",
        "sociales.apoyo_familias": "Apoyo a familias",
        "sociales.dependencia": "Dependencia",

        "otro.medio_ambiente": "Medio ambiente",
        "otro.inmigracion": "InmigraciÃ³n",
        "otro.seguridad": "Seguridad",
        "otro.digitalizacion": "DigitalizaciÃ³n",
        "otro.mundo_rural": "Mundo rural",
        "otro.politicas_sociales": "PolÃ­ticas sociales"
      };

      const laborMap = {
        "Estudiante / en formaciÃ³n": "situacion_laboral.estudiante",
        "Empleado/a con contrato estable": "situacion_laboral.empleo_estable",
        "Empleado/a temporal": "situacion_laboral.empleo_temporal",
        "AutÃ³nomo/a o emprendedor/a": "situacion_laboral.autonomo",
        "Jubilado/a o en transiciÃ³n a la jubilaciÃ³n": "situacion_laboral.jubilacion"
      };

      const questions = [
        {
          id: "demografia",
          title: "InformaciÃ³n demogrÃ¡fica (recomendado)",
          type: "demographic",
          help: "Esta informaciÃ³n no afecta al ranking (por defecto).",
          fields: [
            { name: "genero", label: "GÃ©nero", options: ["Prefiero no decir", "Hombre", "Mujer", "Otro"] },
            { name: "provincia", label: "Provincia", options: ["Prefiero no decir", "Zaragoza", "Huesca", "Teruel"] },
            {
              name: "situacion_laboral",
              label: "SituaciÃ³n laboral",
              options: [
                "Prefiero no decir",
                "Estudiante / en formaciÃ³n",
                "Empleado/a con contrato estable",
                "Empleado/a temporal",
                "AutÃ³nomo/a o emprendedor/a",
                "Jubilado/a o en transiciÃ³n a la jubilaciÃ³n"
              ]
            },
            { name: "vivienda_status", label: "SituaciÃ³n de vivienda", options: ["Prefiero no decir", "Alquiler", "Propietario", "Multipropiedad", "Otra"] }
          ]
        },
        {
          id: "vivienda",
          title: "Â¿QuÃ© es mÃ¡s prioritario para ti en vivienda?",
          options: [
            { label: "Control del precio del alquiler", value: "vivienda.control_alquiler" },
            { label: "ConstrucciÃ³n de vivienda pÃºblica", value: "vivienda.vivienda_publica" },
            { label: "Ayudas a compra de primera vivienda", value: "vivienda.ayudas_compra" },
            { label: "ProtecciÃ³n a propietarios", value: "vivienda.proteccion_propietario" },
            { label: "RegulaciÃ³n turÃ­stica", value: "vivienda.regulacion_turistica" }
          ]
        },
        {
          id: "transportes",
          title: "Â¿QuÃ© es mÃ¡s importante en transportes?",
          options: [
            { label: "Transporte pÃºblico mÃ¡s barato", value: "transportes.transporte_publico_barato" },
            { label: "MÃ¡s inversiÃ³n en carreteras", value: "transportes.carreteras_inversion" },
            { label: "Movilidad sostenible", value: "transportes.movilidad_sostenible" },
            { label: "Infraestructura rural", value: "transportes.infraestructura_rural" },
            { label: "MÃ¡s inversiÃ³n en ferrocarril (cercanÃ­as/medio recorrido)", value: "transportes.ferrocarril_inversion" }
          ]
        },
        {
          id: "sanidad",
          title: "Â¿QuÃ© priorizas en sanidad?",
          options: [
            { label: "Reducir listas de espera", value: "sanidad.listas_espera" },
            { label: "MÃ¡s inversiÃ³n pÃºblica", value: "sanidad.mas_inversion_publica" },
            { label: "ColaboraciÃ³n pÃºblico-privada", value: "sanidad.colaboracion_publico_privada" },
            { label: "Refuerzo de atenciÃ³n primaria", value: "sanidad.atencion_primaria" },
            { label: "Incentivos a seguros/financiaciÃ³n privada (complementaria)", value: "sanidad.financiacion_privada" }
          ]
        },
        {
          id: "economia",
          title: "Â¿QuÃ© es mÃ¡s prioritario en economÃ­a y empleo?",
          options: [
            { label: "Bajada de impuestos", value: "economia.bajada_impuestos" },
            { label: "Apoyo a pymes", value: "economia.apoyo_pymes" },
            { label: "CreaciÃ³n de empleo pÃºblico", value: "economia.empleo_publico" },
            { label: "AtracciÃ³n de inversiÃ³n", value: "economia.atraccion_inversion" },
            { label: "ProtecciÃ³n laboral", value: "economia.proteccion_laboral" }
          ]
        },
        {
          id: "educacion_sociales",
          title: "Â¿QuÃ© priorizas en educaciÃ³n y polÃ­ticas sociales?",
          options: [
            { label: "EducaciÃ³n pÃºblica", value: "educacion.educacion_publica" },
            { label: "Cheque escolar", value: "educacion.cheque_escolar" },
            { label: "MÃ¡s peso a concertada/privada (financiaciÃ³n/bonos)", value: "educacion.financiacion_privada" },
            { label: "PolÃ­ticas de igualdad", value: "sociales.igualdad" },
            { label: "Apoyo a familias", value: "sociales.apoyo_familias" },
            { label: "Dependencia", value: "sociales.dependencia" }
          ]
        },
        {
          id: "otro",
          title: "Â¿QuÃ© tema adicional te preocupa mÃ¡s?",
          options: [
            { label: "Medio ambiente", value: "otro.medio_ambiente" },
            { label: "InmigraciÃ³n", value: "otro.inmigracion" },
            { label: "Seguridad", value: "otro.seguridad" },
            { label: "DigitalizaciÃ³n", value: "otro.digitalizacion" },
            { label: "Mundo rural", value: "otro.mundo_rural" },
            { label: "PolÃ­ticas sociales", value: "otro.politicas_sociales" }
          ]
        },
        {
          id: "prioridad",
          title: "Si tuvieras que elegir solo una prioridad principal:",
          type: "priority",
          options: [
            { label: "Vivienda", value: "vivienda" },
            { label: "Transportes", value: "transportes" },
            { label: "Sanidad", value: "sanidad" },
            { label: "EconomÃ­a y empleo", value: "economia" },
            { label: "EducaciÃ³n", value: "educacion" },
            { label: "PolÃ­ticas sociales", value: "sociales" },
            { label: "Otro", value: "otro" }
          ]
        }
      ];

      const state = {
        stage: "landing",
        currentQuestion: 0,
        answers: {},
        results: [],
        programJson: null
      };

      const el = {
        landing: document.getElementById("landing"),
        quiz: document.getElementById("quiz"),
        loading: document.getElementById("loading"),
        results: document.getElementById("results"),
        startBtn: document.getElementById("startBtn"),
        restartBtn: document.getElementById("restartBtn"),
        progressFill: document.getElementById("progressFill"),
        progressText: document.getElementById("progressText"),
        questionTitle: document.getElementById("questionTitle"),
        questionHelp: document.getElementById("questionHelp"),
        multiHelp: document.getElementById("multiHelp"),
        demographicForm: document.getElementById("demographicForm"),
        options: document.getElementById("options"),
        multiContinue: document.getElementById("multiContinue"),
        resultsList: document.getElementById("resultsList")
      };

      function show(stage) {
        state.stage = stage;
        el.landing.classList.toggle("hidden", stage !== "landing");
        el.quiz.classList.toggle("hidden", stage !== "quiz");
        el.loading.classList.toggle("hidden", stage !== "loading");
        el.results.classList.toggle("hidden", stage !== "results");
      }

      function isMultiSelectQuestion(q) {
        if (!q || !q.options || q.type === "priority" || q.type === "demographic") return false;
        return q.options.length >= 5;
      }

      function getPartyPdfUrl(partyName) {
        if (!state.programJson || !state.programJson.parties) return null;
        const p = state.programJson.parties.find((x) => x.party === partyName);
        return (p && p.source_pdf) || partyPdfFallback[partyName] || null;
      }

      function getPartyTags(partyObj) {
        const t = partyObj.topics || {};
        const economyTopic = t.economia_empleo || t.economia || null;
        const eduSocTopic = t.educacion_politicas_sociales || t.educacion_sociales || t.educacion || null;
        const tags = [
          ...(t.vivienda?.tags || []),
          ...(t.transportes?.tags || []),
          ...(t.sanidad?.tags || []),
          ...((economyTopic && economyTopic.tags) || []),
          ...((eduSocTopic && eduSocTopic.tags) || []),
          ...(t.otro?.tags || [])
        ];
        return new Set(tags);
      }

      function calculateResults(answersOverride) {
        if (!state.programJson || !state.programJson.parties) return [];

        const selectedTags = Object.entries(answersOverride)
          .filter(([qid]) => qid !== "demografia" && qid !== "prioridad")
          .flatMap(([, v]) => (Array.isArray(v) ? v : [v]))
          .filter(Boolean);

        const maxScore = selectedTags.length * PRIORITY_MULTIPLIER;

        return state.programJson.parties
          .map((p) => {
            const partyTags = getPartyTags(p);
            let score = 0;
            const matchList = [];

            selectedTags.forEach((tag) => {
              if (!partyTags.has(tag)) return;
              let points = 1;
              if (answersOverride.prioridad && tag.startsWith(answersOverride.prioridad + ".")) {
                points = PRIORITY_MULTIPLIER;
              }
              score += points;
              const prefix = tag.split(".")[0];
              matchList.push({
                category: prefixLabel[prefix] || prefix,
                match: labelMap[tag] || tag
              });
            });

            return {
              party: p.party,
              score,
              percentage: maxScore ? Math.round((score / maxScore) * 100) : 0,
              matches: matchList
            };
          })
          .sort((a, b) => b.score - a.score);
      }

      function renderQuestion() {
        const q = questions[state.currentQuestion];
        const progress = ((state.currentQuestion + 1) / questions.length) * 100;

        el.progressFill.style.width = progress + "%";
        el.progressText.textContent = "Pregunta " + (state.currentQuestion + 1) + " de " + questions.length;
        el.questionTitle.textContent = q.title;
        el.questionHelp.textContent = q.help || "";

        el.options.innerHTML = "";
        el.demographicForm.innerHTML = "";
        el.multiHelp.classList.add("hidden");
        el.multiContinue.classList.add("hidden");

        if (q.type === "demographic") {
          el.options.classList.add("hidden");
          el.demographicForm.classList.remove("hidden");

          q.fields.forEach((f) => {
            const wrapper = document.createElement("div");
            const label = document.createElement("label");
            label.textContent = f.label;
            const select = document.createElement("select");
            f.options.forEach((opt) => {
              const option = document.createElement("option");
              option.value = opt;
              option.textContent = opt;
              select.appendChild(option);
            });
            select.addEventListener("change", (e) => {
              state.answers.demografia = state.answers.demografia || {};
              state.answers.demografia[f.name] = e.target.value;
            });
            wrapper.appendChild(label);
            wrapper.appendChild(select);
            el.demographicForm.appendChild(wrapper);
          });

          const btn = document.createElement("button");
          btn.className = "cta";
          btn.textContent = "Continuar";
          btn.addEventListener("click", () => {
            const data = state.answers.demografia || {};
            if (laborMap[data.situacion_laboral]) {
              data.situacion_laboral_tag = laborMap[data.situacion_laboral];
            }
            state.answers.demografia = data;
            nextQuestion();
          });
          el.demographicForm.appendChild(btn);
          return;
        }

        el.demographicForm.classList.add("hidden");
        el.options.classList.remove("hidden");

        const multi = isMultiSelectQuestion(q);
        const selected = state.answers[q.id];
        const selectedCount = Array.isArray(selected) ? selected.length : 0;

        if (multi) {
          el.multiHelp.classList.remove("hidden");
          el.multiHelp.innerHTML =
            "Puedes elegir <strong>hasta " + MAX_MULTI + " opciones</strong>. " +
            '<span style="color:#64748b;">Seleccionadas: ' + selectedCount + "/" + MAX_MULTI + "</span>";
          el.multiContinue.classList.remove("hidden");
          el.multiContinue.disabled = selectedCount === 0;
        }

        q.options.forEach((opt) => {
          const btn = document.createElement("button");
          btn.className = "option-btn";
          btn.textContent = opt.label;
          if (multi && Array.isArray(selected) && selected.includes(opt.value)) {
            btn.classList.add("selected");
          }
          btn.addEventListener("click", () => handleOptionClick(opt.value));
          el.options.appendChild(btn);
        });
      }

      function toggleMultiSelect(qid, value) {
        const current = Array.isArray(state.answers[qid]) ? state.answers[qid] : [];
        const exists = current.includes(value);
        if (exists) return current.filter((x) => x !== value);
        if (current.length >= MAX_MULTI) return current;
        return [...current, value];
      }

      function handleOptionClick(value) {
        const q = questions[state.currentQuestion];
        const qid = q.id;

        if (isMultiSelectQuestion(q)) {
          const nextArr = toggleMultiSelect(qid, value);
          state.answers[qid] = nextArr;
          renderQuestion();
          return;
        }

        state.answers[qid] = value;
        nextQuestion();
      }

      function nextQuestion() {
        if (state.currentQuestion < questions.length - 1) {
          state.currentQuestion += 1;
          renderQuestion();
        } else {
          show("loading");
          setTimeout(() => {
            state.results = calculateResults(state.answers);
            renderResults();
            show("results");
          }, 2000);
        }
      }

      function renderResults() {
        el.resultsList.innerHTML = "";
        const medals = ["ðŸ¥‡", "ðŸ¥ˆ", "ðŸ¥‰"];
        state.results.forEach((r, index) => {
          const card = document.createElement("div");
          card.className = "result-card";

          const head = document.createElement("div");
          head.className = "result-head";
          head.innerHTML =
            '<div class="badge">' + (medals[index] || "ðŸ“Š") + "</div>" +
            '<div><div style="font-size:20px;font-weight:700;">' + r.party + "</div>" +
            '<div class="muted">' + r.percentage + "% de afinidad</div></div>";

          card.appendChild(head);

          if (r.matches.length) {
            const p = document.createElement("div");
            p.className = "small";
            p.style.marginBottom = "8px";
            p.textContent = "Coincide contigo especialmente en:";
            card.appendChild(p);

            const ul = document.createElement("ul");
            ul.className = "tag-list";
            r.matches.slice(0, 3).forEach((m) => {
              const li = document.createElement("li");
              li.innerHTML = "<strong>" + m.category + ":</strong> " + m.match;
              ul.appendChild(li);
            });
            card.appendChild(ul);
          }

          const footer = document.createElement("div");
          footer.className = "result-footer";
          const pdf = getPartyPdfUrl(r.party);
          if (pdf) {
            const a = document.createElement("a");
            a.className = "link";
            a.href = pdf;
            a.target = "_blank";
            a.rel = "noreferrer";
            a.textContent = "Ver programa completo";
            footer.appendChild(a);
          } else {
            const span = document.createElement("span");
            span.className = "small";
            span.textContent = "Programa no disponible";
            footer.appendChild(span);
          }
          card.appendChild(footer);

          el.resultsList.appendChild(card);
        });
      }

      async function loadData() {
        try {
          if (window.__PROGRAM_DATA__) {
            state.programJson = window.__PROGRAM_DATA__;
            return;
          }
          const res = await fetch(JSON_URL);
          if (!res.ok) throw new Error("No se pudo cargar " + JSON_URL + " (" + res.status + ")");
          state.programJson = await res.json();
        } catch (e) {
          state.programJson = { parties: [] };
          console.warn(e.message);
        }
      }

      el.startBtn.addEventListener("click", () => {
        state.currentQuestion = 0;
        state.answers = {};
        show("quiz");
        renderQuestion();
      });

      el.restartBtn.addEventListener("click", () => {
        state.currentQuestion = 0;
        state.answers = {};
        show("landing");
      });

      el.multiContinue.addEventListener("click", () => {
        const q = questions[state.currentQuestion];
        const selected = state.answers[q.id];
        if (!Array.isArray(selected) || selected.length === 0) return;
        nextQuestion();
      });

      loadData();
    </script>
  </body>
</html>
