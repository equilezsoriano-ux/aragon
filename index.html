import React, { useEffect, useMemo, useState } from "react";
import { ChevronRight, Check, FileText, Shield, Users, TrendingUp, Share2, Download } from "lucide-react";

/**
 * VITE SETUP
 * 1) Put JSON in: /public/data/aragon_2026_programas_structured.json
 * 2) Put PDFs in: /public/pdfs/<file>.pdf
 * 3) Add `source_pdf` per party in JSON (recommended). Fallback map below if missing.
 */

const JSON_URL = "/data/aragon_2026_programas_structured.json";

/** Fallback PDF mapping if JSON doesn't include source_pdf per party */
const partyPdfFallback = {
  "PP Arag√≥n": "/pdfs/programa_2026.pdf",
  "PSOE Arag√≥n": "/pdfs/Programa-Electoral-PSOE-Aragon-2026-2030.pdf",
  "VOX Arag√≥n": "/pdfs/PROGRAMA-ELECTORAL-VOX-ARAGON-2026.pdf",
  "Podemos - Alianza Verde": "/pdfs/Programa completo Podemos-Alianza Verde.pdf",
  "IU / Sumar": "/pdfs/iu_sumar_programa_revista.pdf",
  "CHA": "/pdfs/CHA2026.pdf",
  "PAR": "/pdfs/programa2026PAR.pdf",
  "Arag√≥n Existe": "/pdfs/Programa Aragon Existe 8F BREVE -1-.pdf",
  "SALF": "/pdfs/Contrato Electoral Aragon SALF 2026.pdf"
};

/** Human labels for prefixes (for results UI) */
const prefixLabel = {
  vivienda: "Vivienda",
  transportes: "Transportes",
  sanidad: "Sanidad",
  economia: "Econom√≠a y empleo",
  educacion: "Educaci√≥n",
  sociales: "Pol√≠ticas sociales",
  otro: "Otro"
};

/** Tag -> label (for results UI) */
const labelMap = {
  // Vivienda
  "vivienda.control_alquiler": "Control del precio del alquiler",
  "vivienda.vivienda_publica": "Construcci√≥n de vivienda p√∫blica",
  "vivienda.ayudas_compra": "Ayudas a compra de primera vivienda",
  "vivienda.proteccion_propietario": "Protecci√≥n a propietarios",
  "vivienda.regulacion_turistica": "Regulaci√≥n tur√≠stica",

  // Transportes
  "transportes.transporte_publico_barato": "Transporte p√∫blico m√°s barato",
  "transportes.carreteras_inversion": "M√°s inversi√≥n en carreteras",
  "transportes.movilidad_sostenible": "Movilidad sostenible",
  "transportes.infraestructura_rural": "Infraestructura rural",
  "transportes.ferrocarril_inversion": "M√°s inversi√≥n en ferrocarril (cercan√≠as/media distancia)",

  // Sanidad
  "sanidad.listas_espera": "Reducir listas de espera",
  "sanidad.mas_inversion_publica": "M√°s inversi√≥n p√∫blica",
  "sanidad.colaboracion_publico_privada": "Colaboraci√≥n p√∫blico-privada",
  "sanidad.atencion_primaria": "Refuerzo de atenci√≥n primaria",
  "sanidad.financiacion_privada": "Incentivar opciones privadas/complementarias",

  // Econom√≠a
  "economia.bajada_impuestos": "Bajada de impuestos",
  "economia.apoyo_pymes": "Apoyo a pymes",
  "economia.empleo_publico": "Creaci√≥n de empleo p√∫blico",
  "economia.atraccion_inversion": "Atracci√≥n de inversi√≥n",
  "economia.proteccion_laboral": "Protecci√≥n laboral",

  // Educaci√≥n / Sociales
  "educacion.educacion_publica": "Educaci√≥n p√∫blica",
  "educacion.cheque_escolar": "Cheque escolar",
  "educacion.financiacion_privada": "Incentivar opciones privadas/concertadas",
  "sociales.igualdad": "Pol√≠ticas de igualdad",
  "sociales.apoyo_familias": "Apoyo a familias",
  "sociales.dependencia": "Dependencia",

  // Otro
  "otro.medio_ambiente": "Medio ambiente",
  "otro.inmigracion": "Inmigraci√≥n",
  "otro.seguridad": "Seguridad",
  "otro.digitalizacion": "Digitalizaci√≥n",
  "otro.mundo_rural": "Mundo rural",
  "otro.politicas_sociales": "Pol√≠ticas sociales"
};

/** Demographics mapping (optional tags, not used in scoring by default) */
const laborMap = {
  "Estudiante / en formaci√≥n": "situacion_laboral.estudiante",
  "Empleado/a con contrato estable": "situacion_laboral.empleo_estable",
  "Empleado/a temporal": "situacion_laboral.empleo_temporal",
  "Aut√≥nomo/a o emprendedor/a": "situacion_laboral.autonomo",
  "Jubilado/a o en transici√≥n a la jubilaci√≥n": "situacion_laboral.jubilacion"
};

function uniq(arr) {
  return Array.from(new Set(arr));
}

function tagPrefix(tag) {
  return (tag || "").split(".")[0];
}

/** Build a share image (1200x630) for socials */
async function buildShareImage({ title, subtitle, top3 }) {
  const canvas = document.createElement("canvas");
  canvas.width = 1200;
  canvas.height = 630;
  const ctx = canvas.getContext("2d");

  // Background
  ctx.fillStyle = "#0f172a"; // slate-900
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  // Card
  ctx.fillStyle = "#ffffff";
  roundRect(ctx, 60, 60, 1080, 510, 24);
  ctx.fill();

  // Title
  ctx.fillStyle = "#0f172a";
  ctx.font = "bold 44px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(title, 110, 150);

  // Subtitle
  ctx.fillStyle = "#334155"; // slate-700
  ctx.font = "26px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  wrapText(ctx, subtitle, 110, 195, 980, 32);

  // Top 3
  const startY = 285;
  const rowH = 92;

  top3.forEach((r, i) => {
    const y = startY + i * rowH;

    // rank bubble
    ctx.fillStyle = "#0f172a";
    ctx.beginPath();
    ctx.arc(135, y - 8, 26, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "#ffffff";
    ctx.font = "bold 28px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.textAlign = "center";
    ctx.fillText(String(i + 1), 135, y + 2);

    // Party
    ctx.textAlign = "left";
    ctx.fillStyle = "#0f172a";
    ctx.font = "bold 30px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(r.party, 190, y);

    // Percentage
    ctx.fillStyle = "#334155";
    ctx.font = "24px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(`${r.percentage}% afinidad`, 190, y + 34);

    // bar background
    ctx.fillStyle = "#e2e8f0"; // slate-200
    roundRect(ctx, 520, y - 30, 560, 18, 10);
    ctx.fill();

    // bar fill
    ctx.fillStyle = "#0f172a";
    roundRect(ctx, 520, y - 30, Math.max(8, 560 * (r.percentage / 100)), 18, 10);
    ctx.fill();
  });

  // Footer
  ctx.fillStyle = "#64748b"; // slate-500
  ctx.font = "20px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("Comparador de programas oficiales ¬∑ Arag√≥n 2026", 110, 545);

  return await new Promise((resolve) => {
    canvas.toBlob((blob) => resolve(blob), "image/png", 0.95);
  });
}

function roundRect(ctx, x, y, w, h, r) {
  const min = Math.min(w, h);
  if (r > min / 2) r = min / 2;
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
}

function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
  const words = (text || "").split(" ");
  let line = "";
  for (let n = 0; n < words.length; n++) {
    const testLine = line + words[n] + " ";
    const metrics = ctx.measureText(testLine);
    if (metrics.width > maxWidth && n > 0) {
      ctx.fillText(line, x, y);
      line = words[n] + " ";
      y += lineHeight;
    } else {
      line = testLine;
    }
  }
  ctx.fillText(line, x, y);
}

const PoliticalQuiz = () => {
  const [stage, setStage] = useState("landing"); // landing, quiz, loading, results
  const [currentQuestion, setCurrentQuestion] = useState(0);
  const [answers, setAnswers] = useState({});
  const [results, setResults] = useState(null);

  const [programJson, setProgramJson] = useState(null);
  const [jsonError, setJsonError] = useState(null);

  // Share helpers
  const [shareImgUrl, setShareImgUrl] = useState(null);
  const [shareBusy, setShareBusy] = useState(false);

  useEffect(() => {
    fetch(JSON_URL)
      .then((r) => {
        if (!r.ok) throw new Error(`No se pudo cargar ${JSON_URL} (${r.status})`);
        return r.json();
      })
      .then((data) => setProgramJson(data))
      .catch((e) => setJsonError(e.message));
  }, []);

  // Optional: set meta description dynamically (if you prefer not to touch index.html)
  // Still recommended to set it in /index.html.
  useEffect(() => {
    const content =
      "¬øQu√© partido encaja mejor contigo en estas elecciones de Arag√≥n 2026? Responde 8 preguntas r√°pidas y descubre qu√© propuestas se alinean m√°s con tus prioridades.";
    let meta = document.querySelector('meta[name="description"]');
    if (!meta) {
      meta = document.createElement("meta");
      meta.setAttribute("name", "description");
      document.head.appendChild(meta);
    }
    meta.setAttribute("content", content);
  }, []);

  const questions = useMemo(
    () => [
      {
        id: "demografia",
        title: "Informaci√≥n demogr√°fica (recomendado)",
        type: "demographic",
        fields: [
          { name: "genero", label: "G√©nero", type: "select", options: ["Prefiero no decir", "Hombre", "Mujer", "Otro"] },
          { name: "provincia", label: "Provincia", type: "select", options: ["Prefiero no decir", "Zaragoza", "Huesca", "Teruel"] },
          {
            name: "situacion_laboral",
            label: "Situaci√≥n laboral",
            type: "select",
            options: [
              "Prefiero no decir",
              "Estudiante / en formaci√≥n",
              "Empleado/a con contrato estable",
              "Empleado/a temporal",
              "Aut√≥nomo/a o emprendedor/a",
              "Jubilado/a o en transici√≥n a la jubilaci√≥n"
            ]
          },
          { name: "vivienda_status", label: "Situaci√≥n de vivienda", type: "select", options: ["Prefiero no decir", "Alquiler", "Propietario", "Multipropiedad", "Otra"] }
        ]
      },

      // Multi-select (>=5 options): allow up to 2
      {
        id: "vivienda",
        title: "¬øQu√© es m√°s prioritario para ti en vivienda? (Puedes elegir hasta 2)",
        type: "multi",
        maxSelections: 2,
        options: [
          { label: "Control del precio del alquiler", value: "vivienda.control_alquiler" },
          { label: "Construcci√≥n de vivienda p√∫blica", value: "vivienda.vivienda_publica" },
          { label: "Ayudas a compra de primera vivienda", value: "vivienda.ayudas_compra" },
          { label: "Protecci√≥n a propietarios", value: "vivienda.proteccion_propietario" },
          { label: "Regulaci√≥n tur√≠stica", value: "vivienda.regulacion_turistica" }
        ]
      },

      // Add 5th option + multi
      {
        id: "transportes",
        title: "¬øQu√© es m√°s importante en transportes? (Puedes elegir hasta 2)",
        type: "multi",
        maxSelections: 2,
        options: [
          { label: "Transporte p√∫blico m√°s barato", value: "transportes.transporte_publico_barato" },
          { label: "M√°s inversi√≥n en carreteras", value: "transportes.carreteras_inversion" },
          { label: "Movilidad sostenible", value: "transportes.movilidad_sostenible" },
          { label: "Infraestructura rural", value: "transportes.infraestructura_rural" },
          { label: "M√°s inversi√≥n en ferrocarril", value: "transportes.ferrocarril_inversion" }
        ]
      },

      // Multi (>=5) including private financing option
      {
        id: "sanidad",
        title: "¬øQu√© priorizas en sanidad? (Puedes elegir hasta 2)",
        type: "multi",
        maxSelections: 2,
        options: [
          { label: "Reducir listas de espera", value: "sanidad.listas_espera" },
          { label: "M√°s inversi√≥n p√∫blica", value: "sanidad.mas_inversion_publica" },
          { label: "Colaboraci√≥n p√∫blico-privada", value: "sanidad.colaboracion_publico_privada" },
          { label: "Refuerzo de atenci√≥n primaria", value: "sanidad.atencion_primaria" },
          { label: "Incentivar opciones privadas/complementarias", value: "sanidad.financiacion_privada" }
        ]
      },

      // Multi (>=5)
      {
        id: "economia",
        title: "¬øQu√© es m√°s prioritario en econom√≠a y empleo? (Puedes elegir hasta 2)",
        type: "multi",
        maxSelections: 2,
        options: [
          { label: "Bajada de impuestos", value: "economia.bajada_impuestos" },
          { label: "Apoyo a pymes", value: "economia.apoyo_pymes" },
          { label: "Creaci√≥n de empleo p√∫blico", value: "economia.empleo_publico" },
          { label: "Atracci√≥n de inversi√≥n", value: "economia.atraccion_inversion" },
          { label: "Protecci√≥n laboral", value: "economia.proteccion_laboral" }
        ]
      },

      // Multi (>=5) includes private financing option
      {
        id: "educacion_sociales",
        title: "¬øQu√© priorizas en educaci√≥n y pol√≠ticas sociales? (Puedes elegir hasta 2)",
        type: "multi",
        maxSelections: 2,
        options: [
          { label: "Educaci√≥n p√∫blica", value: "educacion.educacion_publica" },
          { label: "Cheque escolar", value: "educacion.cheque_escolar" },
          { label: "Incentivar opciones privadas/concertadas", value: "educacion.financiacion_privada" },
          { label: "Pol√≠ticas de igualdad", value: "sociales.igualdad" },
          { label: "Apoyo a familias", value: "sociales.apoyo_familias" },
          { label: "Dependencia", value: "sociales.dependencia" }
        ]
      },

      // Multi (>=5), split inmigraci√≥n and seguridad
      {
        id: "otro",
        title: "¬øQu√© tema adicional te preocupa m√°s? (Puedes elegir hasta 2)",
        type: "multi",
        maxSelections: 2,
        options: [
          { label: "Medio ambiente", value: "otro.medio_ambiente" },
          { label: "Inmigraci√≥n", value: "otro.inmigracion" },
          { label: "Seguridad", value: "otro.seguridad" },
          { label: "Digitalizaci√≥n", value: "otro.digitalizacion" },
          { label: "Mundo rural", value: "otro.mundo_rural" },
          { label: "Pol√≠ticas sociales", value: "otro.politicas_sociales" }
        ]
      },

      {
        id: "prioridad",
        title: "Si tuvieras que elegir solo una prioridad principal:",
        type: "priority",
        options: [
          { label: "Vivienda", value: "vivienda" },
          { label: "Transportes", value: "transportes" },
          { label: "Sanidad", value: "sanidad" },
          { label: "Econom√≠a y empleo", value: "economia" },
          { label: "Educaci√≥n", value: "educacion" },
          { label: "Pol√≠ticas sociales", value: "sociales" },
          { label: "Otro", value: "otro" }
        ]
      }
    ],
    []
  );

  const getPartyPdfUrl = (partyName) => {
    const p = programJson?.parties?.find((x) => x.party === partyName);
    return p?.source_pdf || partyPdfFallback[partyName] || null;
  };

  const getPartyTags = (partyObj) => {
    const t = partyObj?.topics || {};
    return new Set([
      ...(t.vivienda?.tags || []),
      ...(t.transportes?.tags || []),
      ...(t.sanidad?.tags || []),
      ...(t.economia_empleo?.tags || []),
      ...(t.educacion_politicas_sociales?.tags || []),
      ...(t.otro?.tags || [])
    ]);
  };

  const calculateResults = () => {
    if (!programJson?.parties?.length) return [];

    // flatten all selected tags (multi answers are arrays)
    const selectedTags = uniq(
      Object.entries(answers)
        .filter(([qid]) => qid !== "demografia" && qid !== "prioridad")
        .flatMap(([, v]) => (Array.isArray(v) ? v : [v]))
        .filter(Boolean)
    );

    const priority = answers.prioridad || null;

    // Max score = sum of per-tag weight assuming every selected tag matched
    const maxScore = selectedTags.reduce((acc, tag) => {
      const w = priority && tag.startsWith(`${priority}.`) ? 2 : 1; // x2 for priority area
      return acc + w;
    }, 0);

    const ranked = programJson.parties
      .map((p) => {
        const partyName = p.party;
        const partyTags = getPartyTags(p);

        let score = 0;
        const matchList = [];

        selectedTags.forEach((tag) => {
          if (!partyTags.has(tag)) return;

          const w = priority && tag.startsWith(`${priority}.`) ? 2 : 1; // x2
          score += w;

          const prefix = tagPrefix(tag);
          matchList.push({
            category: prefixLabel[prefix] || prefix,
            match: labelMap[tag] || tag,
            tag
          });
        });

        return {
          party: partyName,
          score,
          percentage: maxScore ? Math.round((score / maxScore) * 100) : 0,
          matches: matchList
        };
      })
      .sort((a, b) => b.score - a.score);

    return ranked;
  };

  const goNext = () => {
    if (currentQuestion < questions.length - 1) {
      setCurrentQuestion((x) => x + 1);
    } else {
      setStage("loading");
      setTimeout(() => {
        const r = calculateResults();
        setResults(r);
        setStage("results");
      }, 900);
    }
  };

  const handleSingleAnswer = (value) => {
    const qid = questions[currentQuestion].id;
    setAnswers((prev) => ({ ...prev, [qid]: value }));
    goNext();
  };

  const toggleMultiAnswer = (value) => {
    const qid = questions[currentQuestion].id;
    const q = questions[currentQuestion];
    const max = q.maxSelections || 2;

    setAnswers((prev) => {
      const existing = Array.isArray(prev[qid]) ? prev[qid] : [];
      const has = existing.includes(value);

      let next;
      if (has) {
        next = existing.filter((x) => x !== value);
      } else {
        if (existing.length >= max) return prev; // block
        next = [...existing, value];
      }
      return { ...prev, [qid]: next };
    });
  };

  const handleMultiContinue = () => {
    const qid = questions[currentQuestion].id;
    const selected = answers[qid] || [];
    if (!selected || selected.length === 0) return; // require at least 1
    goNext();
  };

  const handleDemographicSubmit = (data) => {
    const clean = { ...data };
    if (laborMap[clean.situacion_laboral]) {
      clean.situacion_laboral_tag = laborMap[clean.situacion_laboral];
    }
    setAnswers((prev) => ({ ...prev, demografia: clean }));
    goNext();
  };

  const prepareShareAssets = async () => {
    if (!results?.length) return;
    setShareBusy(true);
    try {
      const top3 = results.slice(0, 3);
      const blob = await buildShareImage({
        title: "Mis resultados Arag√≥n 2026",
        subtitle: "Top 3 partidos por afinidad seg√∫n mis prioridades (comparando programas oficiales).",
        top3
      });
      if (!blob) return;

      // revoke previous
      if (shareImgUrl) URL.revokeObjectURL(shareImgUrl);

      const url = URL.createObjectURL(blob);
      setShareImgUrl(url);
      return { blob, url };
    } finally {
      setShareBusy(false);
    }
  };

  const shareResults = async () => {
    if (!results?.length) return;

    const top3 = results.slice(0, 3);
    const text = `Mis resultados (Top 3):\n1) ${top3[0]?.party} ‚Äî ${top3[0]?.percentage}%\n2) ${top3[1]?.party} ‚Äî ${top3[1]?.percentage}%\n3) ${top3[2]?.party} ‚Äî ${top3[2]?.percentage}%\n\nHecho con un comparador de programas oficiales (Arag√≥n 2026).`;

    // Try to build image and share file
    let blob = null;
    try {
      const assets = await prepareShareAssets();
      blob = assets?.blob || null;
    } catch {
      blob = null;
    }

    // Web Share API
    if (navigator.share) {
      try {
        if (blob) {
          const file = new File([blob], "resultados-aragon-2026.png", { type: "image/png" });
          const can = navigator.canShare && navigator.canShare({ files: [file] });
          if (can) {
            await navigator.share({ title: "Resultados Arag√≥n 2026", text, files: [file] });
            return;
          }
        }
        await navigator.share({ title: "Resultados Arag√≥n 2026", text });
        return;
      } catch {
        // fall through to clipboard
      }
    }

    // Clipboard fallback
    try {
      await navigator.clipboard.writeText(text);
      alert("Resultados copiados al portapapeles ‚úÖ");
    } catch {
      alert("No se pudo compartir autom√°ticamente. Copia el texto manualmente.");
    }
  };

  const downloadShareImage = async () => {
    const assets = await prepareShareAssets();
    if (!assets?.blob) return;

    const a = document.createElement("a");
    a.href = assets.url;
    a.download = "resultados-aragon-2026.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
  };

  // ---------------- UI ----------------

  if (stage === "landing") {
    return (
      <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100">
        <div className="container mx-auto px-4 py-16 max-w-4xl">
          <div className="text-center mb-16">
            <h1 className="text-4xl md:text-5xl font-bold text-slate-900 mb-6">
              ¬øQu√© partido encaja mejor contigo en estas elecciones?
            </h1>
            <p className="text-xl text-slate-600 mb-8">
              Responde 8 preguntas r√°pidas y descubre qu√© propuestas se alinean m√°s con tus prioridades.
            </p>

            {jsonError && (
              <div className="bg-red-50 border border-red-200 text-red-700 rounded-lg p-4 mb-6 text-sm">
                Error cargando datos: {jsonError}
                <div className="mt-2 text-red-600">
                  Aseg√∫rate de que el JSON est√° en <code>/public{JSON_URL}</code>
                </div>
              </div>
            )}

            <button
              onClick={() => setStage("quiz")}
              disabled={!programJson && !jsonError}
              className="bg-slate-800 disabled:bg-slate-400 hover:bg-slate-700 text-white px-8 py-4 rounded-lg text-lg font-semibold inline-flex items-center gap-2 transition-colors"
            >
              Empezar cuestionario
              <ChevronRight size={20} />
            </button>

            <p className="text-sm text-slate-500 mt-4">
              Herramienta informativa basada en programas oficiales. Sin afiliaci√≥n pol√≠tica.
            </p>
          </div>

          <div className="bg-white rounded-xl shadow-sm p-8 mb-12">
            <h2 className="text-2xl font-bold text-slate-900 mb-8 text-center">¬øC√≥mo funciona?</h2>
            <div className="grid md:grid-cols-3 gap-8">
              <div className="text-center">
                <div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <Users className="text-slate-700" size={28} />
                </div>
                <h3 className="font-semibold text-slate-900 mb-2">1. Responde 8 preguntas</h3>
                <p className="text-slate-600 text-sm">Sobre vivienda, sanidad, econom√≠a y m√°s</p>
              </div>
              <div className="text-center">
                <div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <TrendingUp className="text-slate-700" size={28} />
                </div>
                <h3 className="font-semibold text-slate-900 mb-2">2. Comparamos tus respuestas</h3>
                <p className="text-slate-600 text-sm">Con programas electorales oficiales</p>
              </div>
              <div className="text-center">
                <div className="bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                  <FileText className="text-slate-700" size={28} />
                </div>
                <h3 className="font-semibold text-slate-900 mb-2">3. Ranking personalizado</h3>
                <p className="text-slate-600 text-sm">Recibes % de afinidad y razones</p>
              </div>
            </div>
          </div>

          <div className="bg-slate-800 rounded-xl p-8 text-white">
            <div className="flex items-center gap-2 mb-6">
              <Shield size={24} />
              <h2 className="text-2xl font-bold">Garant√≠as de neutralidad</h2>
            </div>
            <div className="grid md:grid-cols-2 gap-4">
              {["Basado en programas oficiales", "Sin afiliaci√≥n pol√≠tica", "No guardamos datos personales", "Metodolog√≠a transparente"].map((t) => (
                <div key={t} className="flex items-start gap-3">
                  <Check size={20} className="mt-1 flex-shrink-0" />
                  <span>{t}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  }

  if (stage === "quiz") {
    const question = questions[currentQuestion];
    const progress = ((currentQuestion + 1) / questions.length) * 100;

    if (question.type === "demographic") {
      return (
        <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 py-8">
          <div className="container mx-auto px-4 max-w-2xl">
            <ProgressBar progress={progress} current={currentQuestion + 1} total={questions.length} />

            <div className="bg-white rounded-xl shadow-lg p-8">
              <h2 className="text-2xl font-bold text-slate-900 mb-2">{question.title}</h2>
              <p className="text-slate-600 mb-6 text-sm">
                Esta informaci√≥n no afecta al ranking, pero puede ayudar a contextualizar propuestas.
              </p>

              <DemographicForm fields={question.fields} onSubmit={handleDemographicSubmit} />
            </div>
          </div>
        </div>
      );
    }

    const isMulti = question.type === "multi";
    const selected = isMulti ? (Array.isArray(answers[question.id]) ? answers[question.id] : []) : [];

    return (
      <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 py-8">
        <div className="container mx-auto px-4 max-w-2xl">
          <ProgressBar progress={progress} current={currentQuestion + 1} total={questions.length} />

          <div className="bg-white rounded-xl shadow-lg p-8">
            <h2 className="text-2xl font-bold text-slate-900 mb-2">{question.title}</h2>

            {isMulti && (
              <p className="text-sm text-slate-600 mb-6">
                Selecciona hasta <strong>{question.maxSelections || 2}</strong> opciones. Debes elegir al menos 1 para continuar.
              </p>
            )}

            <div className="space-y-3">
              {question.options.map((option) => {
                const active = isMulti ? selected.includes(option.value) : false;
                return (
                  <button
                    key={option.value}
                    onClick={() => (isMulti ? toggleMultiAnswer(option.value) : handleSingleAnswer(option.value))}
                    className={`w-full text-left p-4 rounded-lg border-2 transition-all ${
                      active
                        ? "border-slate-800 bg-slate-50"
                        : "border-slate-200 hover:border-slate-800 hover:bg-slate-50"
                    }`}
                    type="button"
                  >
                    <span className="text-slate-900 font-medium">{option.label}</span>
                    {isMulti && active && (
                      <span className="ml-2 text-xs text-slate-600">(seleccionado)</span>
                    )}
                  </button>
                );
              })}
            </div>

            {isMulti && (
              <button
                type="button"
                onClick={handleMultiContinue}
                disabled={!selected.length}
                className="mt-6 w-full bg-slate-800 disabled:bg-slate-400 hover:bg-slate-700 text-white py-3 rounded-lg font-semibold transition-colors"
              >
                Continuar
              </button>
            )}
          </div>
        </div>
      </div>
    );
  }

  if (stage === "loading") {
    return (
      <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 flex items-center justify-center">
        <div className="text-center">
          <div className="w-16 h-16 border-4 border-slate-200 border-t-slate-800 rounded-full animate-spin mx-auto mb-4" />
          <p className="text-xl text-slate-700">Analizando tu perfil y compar√°ndolo con los programas electorales...</p>
        </div>
      </div>
    );
  }

  if (stage === "results") {
    const medals = ["ü•á", "ü•à", "ü•â"];
    const top3 = (results || []).slice(0, 3);

    return (
      <div className="min-h-screen bg-gradient-to-b from-slate-50 to-slate-100 py-12">
        <div className="container mx-auto px-4 max-w-4xl">
          <div className="text-center mb-10">
            <h1 className="text-4xl font-bold text-slate-900 mb-3">Tus resultados</h1>
            <p className="text-slate-600">Basados en la comparaci√≥n con los programas electorales oficiales</p>
          </div>

          {/* Share actions */}
          <div className="bg-white rounded-xl shadow-lg p-6 mb-8">
            <div className="flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
              <div>
                <h2 className="text-lg font-semibold text-slate-900">Compartir resultados</h2>
                <p className="text-sm text-slate-600">
                  Compartiremos tu top 3 (texto) y, si tu m√≥vil lo permite, tambi√©n una imagen lista para RRSS.
                </p>
              </div>
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={shareResults}
                  disabled={shareBusy}
                  className="inline-flex items-center gap-2 bg-slate-800 disabled:bg-slate-400 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"
                >
                  <Share2 size={18} />
                  Compartir
                </button>
                <button
                  type="button"
                  onClick={downloadShareImage}
                  disabled={shareBusy}
                  className="inline-flex items-center gap-2 border-2 border-slate-200 hover:border-slate-800 px-4 py-2 rounded-lg font-semibold text-slate-900 transition-colors"
                >
                  <Download size={18} />
                  Descargar imagen
                </button>
              </div>
            </div>

            {shareImgUrl && (
              <div className="mt-4">
                <p className="text-sm text-slate-600 mb-2">Vista previa (PNG 1200√ó630):</p>
                <img
                  src={shareImgUrl}
                  alt="Vista previa resultados"
                  className="w-full rounded-lg border border-slate-200"
                />
              </div>
            )}
          </div>

          <div className="space-y-6 mb-10">
            {(results || []).map((result, index) => {
              const pdfUrl = getPartyPdfUrl(result.party);
              return (
                <div key={result.party} className="bg-white rounded-xl shadow-lg p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex items-center gap-3">
                      <span className="text-3xl">{medals[index] || "üìä"}</span>
                      <div>
                        <h3 className="text-2xl font-bold text-slate-900">{result.party}</h3>
                        <p className="text-slate-600">{result.percentage}% de afinidad</p>
                      </div>
                    </div>
                  </div>

                  {result.matches.length > 0 && (
                    <div className="mb-4">
                      <p className="text-sm font-semibold text-slate-700 mb-2">Coincide contigo especialmente en:</p>
                      <ul className="space-y-1">
                        {result.matches.slice(0, 3).map((match, i) => (
                          <li key={i} className="text-sm text-slate-600 flex items-start gap-2">
                            <Check size={16} className="mt-0.5 text-slate-400 flex-shrink-0" />
                            <span>
                              <strong>{match.category}:</strong> {match.match}
                            </span>
                          </li>
                        ))}
                      </ul>
                    </div>
                  )}

                  {pdfUrl ? (
                    <a
                      href={pdfUrl}
                      target="_blank"
                      rel="noreferrer"
                      className="text-slate-800 hover:text-slate-600 text-sm font-medium inline-flex items-center gap-1"
                    >
                      <FileText size={16} />
                      Ver programa completo
                    </a>
                  ) : (
                    <div className="text-slate-500 text-sm inline-flex items-center gap-1">
                      <FileText size={16} />
                      Programa no disponible
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          <div className="bg-slate-100 rounded-lg p-6 text-center text-sm text-slate-600">
            <p>
              Esta herramienta compara tus respuestas con los programas oficiales. No sustituye el criterio personal ni recomienda el voto.
            </p>
          </div>

          <div className="text-center mt-8">
            <button
              onClick={() => {
                setStage("landing");
                setCurrentQuestion(0);
                setAnswers({});
                setResults(null);
                if (shareImgUrl) URL.revokeObjectURL(shareImgUrl);
                setShareImgUrl(null);
              }}
              className="text-slate-600 hover:text-slate-900 font-medium"
            >
              Volver a empezar
            </button>
          </div>
        </div>
      </div>
    );
  }

  return null;
};

const ProgressBar = ({ progress, current, total }) => (
  <div className="mb-8">
    <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
      <div className="h-full bg-slate-800 transition-all" style={{ width: `${progress}%` }} />
    </div>
    <p className="text-sm text-slate-600 mt-2 text-center">
      Pregunta {current} de {total}
    </p>
  </div>
);

const DemographicForm = ({ fields, onSubmit }) => {
  const [formData, setFormData] = useState({});

  const handleClick = (e) => {
    e.preventDefault();
    onSubmit(formData);
  };

  return (
    <div className="space-y-6">
      {fields.map((field) => (
        <div key={field.name}>
          <label className="block text-sm font-medium text-slate-700 mb-2">{field.label}</label>
          <select
            className="w-full p-3 border-2 border-slate-200 rounded-lg focus:border-slate-800 focus:outline-none"
            value={formData[field.name] || ""}
            onChange={(e) => setFormData({ ...formData, [field.name]: e.target.value })}
          >
            {field.options.map((option) => (
              <option key={option} value={option}>
                {option}
              </option>
            ))}
          </select>
        </div>
      ))}

      <button
        onClick={handleClick}
        className="w-full bg-slate-800 hover:bg-slate-700 text-white py-3 rounded-lg font-semibold transition-colors"
      >
        Continuar
      </button>
    </div>
  );
};
